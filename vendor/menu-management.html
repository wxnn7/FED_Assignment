<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Management - Digital Hawker</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css?v=2">
    <link rel="stylesheet" href="../css/navbar.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <!-- jQuery (required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="../js/auth-check.js"></script>
    <script src="../js/image-helper.js"></script>
    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, onSnapshot, addDoc, deleteDoc, updateDoc, doc, setDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { seedMenuData } from '../js/seed-menu.js';

        console.log("Menu Management Module Loaded");

        // Cache for Edit Population
        window.menuItemsCache = {};

        // Attach Reset Listener
        const btnReset = document.getElementById('btnResetData');
        if (btnReset) {
            btnReset.addEventListener('click', async () => {
                if (confirm("Are you sure you want to RESET all menu data to Singaporean defaults? This cannot be undone.")) {
                    btnReset.disabled = true;
                    btnReset.innerHTML = "Resetting...";
                    await seedMenuData();
                    btnReset.disabled = false;
                    btnReset.innerHTML = '<ion-icon name="refresh-outline"></ion-icon> Reset Data';
                }
            });
            console.log("Reset button listener attached");
        } else {
            console.error("Reset button not found!");
        }

        const menuTableBody = document.getElementById('menuTableBody');

        // Real-time Listener
        onSnapshot(collection(db, "menu_items"), (snapshot) => {
            if (!menuTableBody) return;

            // Destroy existing DataTable if it exists
            if ($.fn.DataTable.isDataTable('#menuTable')) {
                $('#menuTable').DataTable().destroy();
            }

            menuTableBody.innerHTML = ''; // Clear table
            window.menuItemsCache = {}; // Reset cache

            snapshot.forEach((docSnap) => {
                const item = docSnap.data();
                window.menuItemsCache[docSnap.id] = item; // Store in cache

                const row = `
                    <tr data-id="${docSnap.id}">
                        <td>
                            <div class="checkbox-sq" data-id="${docSnap.id}" onclick="this.classList.toggle('checked'); event.stopPropagation();"></div>
                        </td>
                        <td>${docSnap.id.substring(0, 6)}</td>
                        <td>
                            ${item.name}
                            ${item.promotion ? `<span style="background:#d32f2f; color:white; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:700; margin-left:8px;">PROMO</span>` : ''}
                        </td>
                        <td>
                            ${Number(item.price).toFixed(2)}
                            ${item.promotion ? `<br><small style='color:red; font-weight:700;'>(-${item.promotion.discount}%)</small>` : ''}
                        </td>
                        <td>${item.category}</td>
                        <td>${item.ingredients || '-'}</td>
                        <td>${item.description ? item.description.substring(0, 50) + '...' : '-'}</td>
                        <td>${item.dietary || '-'}</td>
                    </tr>
                `;
                menuTableBody.innerHTML += row;
            });

            // Initialize DataTable after data is loaded
            $('#menuTable').DataTable({
                pageLength: 10,
                order: [[2, 'asc']], // Sort by name (column 2)
                columnDefs: [
                    { orderable: false, targets: 0 }, // Checkbox column
                ],
                language: {
                    search: "Search items:",
                    lengthMenu: "Show _MENU_ items per page",
                    info: "Showing _START_ to _END_ of _TOTAL_ items",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                }
            });
        });

        // Helper: Image Path Updater
        window.updateImagePath = (mode, input) => {
            if (input.files && input.files[0]) {
                const filename = input.files[0].name;
                const targetInput = document.getElementById(mode === 'add' ? 'addImage' : 'editImage');
                targetInput.value = `../images/${filename}`;
            }
        };

        // Real-time Search (Linked to DataTables)
        window.searchItems = () => {
            const query = document.getElementById('searchInput').value;
            // Use DataTables API to search and draw
            if ($.fn.DataTable.isDataTable('#menuTable')) {
                $('#menuTable').DataTable().search(query).draw();
            }
        };

        // Sorting
        let sortDir = { name: 1, price: 1 };
        window.sortItems = (key) => {
            const tableBody = document.getElementById('menuTableBody');
            const rows = Array.from(tableBody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                let valA, valB;
                if (key === 'name') {
                    valA = a.cells[2].innerText.toLowerCase();
                    valB = b.cells[2].innerText.toLowerCase();
                    return valA.localeCompare(valB) * sortDir.name;
                } else if (key === 'price') {
                    valA = parseFloat(a.cells[3].innerText.replace('$ ', ''));
                    valB = parseFloat(b.cells[3].innerText.replace('$ ', ''));
                    return (valA - valB) * sortDir.price;
                }
                return 0;
            });

            sortDir[key] *= -1; // Toggle direction
            tableBody.innerHTML = '';
            rows.forEach(row => tableBody.appendChild(row));
        };

        // Bulk Actions
        function getSelectedIds() {
            const checkedBoxes = document.querySelectorAll('.checkbox-sq.checked');
            return Array.from(checkedBoxes).map(box => box.getAttribute('data-id'));
        }

        // Helper to get variants from UI
        function getVariantsFromUI(mode) {
            const container = document.getElementById(`${mode}VariantsContainer`);
            const rows = container.querySelectorAll('.variant-row');
            const variants = [];
            rows.forEach(row => {
                const name = row.querySelector('.var-name').value;
                const price = Number(row.querySelector('.var-price').value);
                if (name && price) {
                    variants.push({ name, price });
                }
            });
            return variants;
        }

        // Helper to add variant row
        window.addVariantRow = (mode, data = { name: '', price: '' }) => {
            const container = document.getElementById(`${mode}VariantsContainer`);
            const div = document.createElement('div');
            div.className = 'variant-row';
            div.style.display = 'flex';
            div.style.gap = '8px';
            div.style.marginBottom = '8px';
            div.innerHTML = `
                <input type="text" class="var-name" placeholder="Size/Type" value="${data.name}" style="flex:1;">
                <input type="number" class="var-price" placeholder="Price" value="${data.price}" style="width:100px;">
                <button class="btn-tool" onclick="this.parentElement.remove()" style="color:red; border-color:red;">X</button>
            `;
            container.appendChild(div);
        };

        // Updated Add Item Logic (Includes Image)
        window.confirmAddItem = async () => {
            const name = document.getElementById('addName').value;
            const price = Number(document.getElementById('addPrice').value);
            const cost = Number(document.getElementById('addCost').value) || 0;
            const category = document.getElementById('addGroup').value;
            const ingredients = document.getElementById('addIngredients').value;
            const description = document.getElementById('addDesc').value;
            const dietary = document.getElementById('addDiet').value;
            const imageUrl = document.getElementById('addImage').value || '../images/default.jpg';
            const id = document.getElementById('addId').value;

            const variants = getVariantsFromUI('add');

            if (!name || !price) {
                alert("Name and Price are required!");
                return;
            }

            try {
                // Use custom ID if provided, else auto-gen
                const data = {
                    name, price, cost, category, ingredients, description, dietary, imageUrl,
                    available: true,
                    stock: 50,
                    variants: variants // Add variants to data
                };

                if (id) {
                    await setDoc(doc(db, "menu_items", id), data);
                } else {
                    await addDoc(collection(db, "menu_items"), data);
                }

                window.showSuccessModal('Item Added Successfully!', 'New Item', name);
                document.getElementById('addModal').style.display = 'none';
                document.querySelectorAll('#addModal input').forEach(i => i.value = '');
                document.getElementById('addVariantsContainer').innerHTML = ''; // Clear variants
            } catch (error) {
                console.error("Error adding item:", error);
                alert("Failed to add item: " + error.message);
            }
        };

        // Updated Edit Logic
        window.confirmEdit = async () => {
            const variants = getVariantsFromUI('edit');
            const id = document.getElementById('editId').value;

            const selectedIds = getSelectedIds();
            const targetIds = (selectedIds.length > 0 && currentAction !== 'edit-single') ? selectedIds : [id];

            const name = document.getElementById('editName').value;
            const price = Number(document.getElementById('editPrice').value);
            const cost = Number(document.getElementById('editCost').value) || 0;
            const category = document.getElementById('editGroup').value;
            const ingredients = document.getElementById('editIngredients').value;
            const description = document.getElementById('editDesc').value;
            const dietary = document.getElementById('editDiet').value;
            const imageUrl = document.getElementById('editImage').value || '../images/default.jpg';

            try {
                // Bulk Edit Logic
                if (targetIds.length > 1) {
                    const updates = {};
                    if (category) updates.category = category;

                    const promises = targetIds.map(tid => updateDoc(doc(db, "menu_items", tid), updates));
                    await Promise.all(promises);
                    window.showSuccessModal('Items Updated!', 'Bulk Edit', `${targetIds.length} items updated.`);
                }
                else {
                    // Single item logic
                    if (!name || !price) { alert("Name and Price required"); return; }

                    await updateDoc(doc(db, "menu_items", id), {
                        name, price, cost, category, ingredients, description, dietary, imageUrl,
                        variants: variants
                    });
                    window.showSuccessModal('Item Updated!', 'Edit Item', 'Changes saved successfully.');
                }

                document.getElementById('editModal').style.display = 'none';
                document.querySelectorAll('.checkbox-sq.checked').forEach(c => c.classList.remove('checked'));

            } catch (error) {
                console.error("Error updating item:", error);
                alert("Failed to update item: " + error.message);
            }
        };

        // ... (Inside onSnapshot) update openEditModal to populate image


        // Confirm Remove Promotion (Logic)
        window.confirmRemovePromo = async () => {
            const targetId = currentItem;
            if (!targetId) return;

            try {
                const itemRef = doc(db, "menu_items", targetId);
                await updateDoc(itemRef, {
                    promotion: deleteField()
                });

                // if(typeof hideContextMenu === 'function') hideContextMenu();
                window.showSuccessModal('Promotion Removed!', 'Promotion', 'The promotion has been removed.');
            } catch (error) {
                console.error("Error removing promo:", error);
                alert("Failed to remove promotion: " + error.message);
            }
        };

        // Delete Logic (Bulk or Single)
        window.confirmDelete = async () => {
            // If context item is set, delete only that
            if (currentAction === 'delete-single' && currentItem) {
                await deleteDoc(doc(db, "menu_items", currentItem));
                window.showSuccessModal('Item Deleted!', 'Deleted', '1 item removed.');
                currentItem = null; // Reset
                return;
            }

            const checkedBoxes = document.querySelectorAll('.checkbox-sq.checked');
            if (checkedBoxes.length === 0) {
                alert("No items selected to delete.");
                return;
            }

            for (const box of checkedBoxes) {
                const id = box.getAttribute('data-id');
                if (id) {
                    await deleteDoc(doc(db, "menu_items", id));
                }
            }
            window.showSuccessModal('Items Deleted!', 'Deleted', `${checkedBoxes.length} items removed.`);
        };


        // --- Group Management (Module Scope) ---
        onSnapshot(collection(db, "menu_groups"), (snapshot) => {
            const groupSelects = [
                document.getElementById('addGroup'),
                document.getElementById('editGroup')
            ];
            const groupList = document.getElementById('groupList');
            const filterDropdown = document.getElementById('filterDropdown');

            // Reset Selects
            groupSelects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Select Group..</option>';
                }
            });

            // Reset Group List in Popover
            if (groupList) {
                const newGroupBtn = groupList.lastElementChild;
                groupList.innerHTML = '';
            }

            // Reset Filter Dropdown
            if (filterDropdown) {
                const container = document.getElementById('dynamicFilterOptions');
                if (container) container.innerHTML = '';
            }

            snapshot.forEach(docSnap => {
                const groupName = docSnap.data().name;

                // Populate Selects
                groupSelects.forEach(select => {
                    if (select) {
                        select.innerHTML += `<option value="${groupName}">${groupName}</option>`;
                    }
                });

                // Populate Group Popover List (Toolbar)
                if (groupList) {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item group-item';
                    div.innerText = groupName;
                    div.onclick = (e) => {
                        alert(`Selected Group: ${groupName}`);
                    };
                    groupList.appendChild(div);
                }

                // Populate Filter Dropdown
                if (filterDropdown) {
                    const container = document.getElementById('dynamicFilterOptions');
                    if (container) {
                        const div = document.createElement('div');
                        div.className = 'dropdown-item';
                        div.innerText = groupName;
                        div.onclick = () => window.filterItems(groupName);
                        container.appendChild(div);
                    }
                }
            });

            // Re-append "New Group" button
            if (groupList) {
                const newGroupOption = document.createElement('div');
                newGroupOption.className = 'dropdown-item group-item';
                newGroupOption.style = 'border-top:1px solid #FFD54F; margin-top:4px; font-weight:600;';
                newGroupOption.onclick = (e) => showNewGroupForm(e);
                newGroupOption.innerText = 'New Group';
                groupList.appendChild(newGroupOption);
            }
        });

        // Filter State
        let currentCategoryFilter = 'all';

        // Filter Function (Category)
        window.filterItems = (category) => {
            currentCategoryFilter = category;
            window.applyAdvancedFilter();
        };

        // Advanced Filter (Category + Price)
        window.applyAdvancedFilter = () => {
            const minPrice = parseFloat(document.getElementById('filterMinPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('filterMaxPrice').value) || Infinity;

            const rows = document.querySelectorAll('#menuTableBody tr');
            rows.forEach(row => {
                const priceText = row.cells[3].innerText.replace('$ ', ''); // 4th column is Price
                const price = parseFloat(priceText);
                const groupCell = row.cells[4]; // 5th column is Group

                const matchesCategory = (currentCategoryFilter === 'all' || groupCell.innerText === currentCategoryFilter);
                const matchesPrice = (price >= minPrice && price <= maxPrice);

                if (matchesCategory && matchesPrice) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });

            // Close dropdown
            const filterDropdown = document.getElementById('filterDropdown');
            if (filterDropdown) filterDropdown.style.display = 'none';
        };

        // Context Menu Group Assignment
        window.openGroupAssignmentCtx = () => {
            // For simplicity, let's open the Edit Modal but strictly for Group assignment?
            // Or better, reuse the "Edit Modal" but maybe focus on it.
            // Let's just open the Edit Modal as it allows changing the group.
            // Ideally we would have a specific small modal, but time efficiency.
            openEditModal(true);
            // Focus on group?
            setTimeout(() => document.getElementById('editGroup').focus(), 100);
        };

        window.addNewGroup = async () => {
            const groupNameInput = document.querySelector('#newGroupForm input');
            const newGroup = groupNameInput.value;
            if (newGroup) {
                try {
                    await addDoc(collection(db, "menu_groups"), {
                        name: newGroup,
                        created_at: new Date()
                    });
                    showSuccessModal('New Group Added!', 'Group', newGroup);
                    document.getElementById('groupPopover').style.display = 'none';
                    groupNameInput.value = '';
                } catch (error) {
                    console.error("Error adding group:", error);
                    alert("Failed to add group: " + error.message);
                }
            } else {
                alert("Please enter a group name");
            }
        };

        // --- Promotion Logic (Module Scope) ---
        onSnapshot(collection(db, "promotions"), (snapshot) => {
            const promoList = document.getElementById('promoList');
            if (!promoList) return;

            const oldPromos = promoList.querySelectorAll('.dynamic-promo');
            oldPromos.forEach(el => el.remove());

            const addBtn = promoList.lastElementChild;

            snapshot.forEach(docSnap => {
                const promo = docSnap.data();
                const promoLabel = `${promo.name}<br>${promo.discount_percentage}% Promotion`;

                const li = document.createElement('li');
                li.className = 'ctx-item promo-badge dynamic-promo';
                li.innerHTML = promoLabel;
                li.onclick = () => window.applyPromotion(promo.name, promo.discount_percentage);

                promoList.insertBefore(li, addBtn);
            });
        });

        window.applyPromotion = async (promoName, discount) => {
            const targetId = currentItem;
            if (!targetId) return;

            try {
                const itemRef = doc(db, "menu_items", targetId);
                await updateDoc(itemRef, {
                    promotion: {
                        name: promoName,
                        discount: discount,
                        applied_at: new Date()
                    }
                });

                if (typeof hideContextMenu === 'function') hideContextMenu();
                window.showSuccessModal('Promotion Applied!', 'Promotion', `${promoName} (${discount}%) applied.`);
            } catch (error) {
                console.error("Error applying promo:", error);
                alert("Failed to apply promotion");
            }
        };

        window.submitPromotion = async () => {
            const name = document.getElementById('newPromoName').value;
            const amount = document.getElementById('newPromoAmount').value;

            if (!name || !amount) {
                alert("Please enter promotion name and amount");
                return;
            }

            try {
                await addDoc(collection(db, "promotions"), {
                    name: name,
                    discount_percentage: Number(amount),
                    created_at: new Date()
                });
                if (typeof hideContextMenu === 'function') hideContextMenu();
                window.showSuccessModal('New Promotion Created!', 'Promotion', `${name} (${amount}%)`);
            } catch (error) {
                console.error("Error creating promo:", error);
                alert("Failed to create promotion: " + error.message);
            }
        };
    </script>
    <style>
        body {
            background-color: #FFF8E1;
            /* Cream background */
            font-family: 'Outfit', sans-serif;
            margin: 0;
            color: #333;
        }

        .split-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 40px;
        }

        /* Hide default DataTables search box */
        .dataTables_filter {
            display: none;
        }

        @media screen and (max-width: 768px) {
            .split-layout {
                display: flex;
                flex-direction: column;
            }

            .nav-stack {
                width: 100%;
                margin-bottom: 20px;
            }
        }
    </style>

    <script>function toggleMobileNav() {
            document.getElementById('navLinksContainer').classList.toggle('show');
        }

        // User Dropdown Toggle
        document.addEventListener('DOMContentLoaded', () => {
            const userDropdown = document.querySelector('.user-dropdown');
            const userToggle = document.querySelector('.user-toggle');

            if (userToggle) {
                userToggle.addEventListener('click', (event) => {
                    userDropdown.classList.toggle('active');
                    event.stopPropagation(); // Prevent click from immediately closing
                });
            }

            // Close dropdown if clicked outside
            window.addEventListener('click', (event) => {
                if (userDropdown && !userDropdown.contains(event.target)) {
                    userDropdown.classList.remove('active');
                }
            });
        });
    </script>
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar">
    <div class="nav-container">

    <!-- Logo -->
    <a href="VendorHomePage.html" class="nav-logo">
      <span class="logo-icon">üçú</span>
      <span class="logo-text">Digital<br />Hawker</span>
    </a>

    <!-- Nav Links -->
    <ul class="nav-links">
      <li><a href="VendorHomePage.html">Home</a></li>
      <li><a href="browse-stalls.html" class="active">Order</a></li>
      <li><a href="orders-history.html">Order History</a></li>
      <li><a href="contact.html">Contact Us</a></li>
    </ul>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-nav-toggle" aria-label="Mobile Menu">
      <ion-icon name="menu"></ion-icon> Menu
    </button>

    <!-- User Section -->
    <div class="nav-user">
      <button class="btn-notification" aria-label="Notifications" onclick="location.href='VendorNotification.html'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <span class="notification-badge">3</span>
      </button>

      <!-- User Dropdown -->
      <div class="user-dropdown">
        <button class="user-toggle" aria-label="User menu">
          <div class="user-avatar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <span class="user-name">Vendor</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>
        <div class="dropdown-menu">
          <a href="settings.html" class="dropdown-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            Settings
          </a>
          <div class="dropdown-divider"></div>
          <a href="../login.html" class="dropdown-item dropdown-logout">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Log Out
          </a>
        </div>
      </div>
    </div>
  </div>
</nav>


    <div style="max-width: 1400px; margin: 0 auto; padding: 40px 20px;">
        <!-- Full Width Content -->
        <div class="split-layout">
            <!-- Sidebar -->
            <div class="nav-stack">
                <button class="mobile-nav-toggle" onclick="toggleMobileNav()">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <ion-icon name="menu"></ion-icon> Menu
                    </div>
                    <ion-icon name="chevron-down-outline"></ion-icon>
                </button>
                <div id="navLinksContainer" class="nav-links-container">
                    <a href="VendorHomePage.html" class="menu-pill-btn">
                        <ion-icon name="grid"></ion-icon> Dashboard
                    </a>
                    <a href="menu.html" class="menu-pill-btn active">
                        <ion-icon name="restaurant"></ion-icon> Menu
                    </a>
                    <a href="orders.html" class="menu-pill-btn">
                        <ion-icon name="cart"></ion-icon> Order
                    </a>
                    <a href="earnings-overview.html" class="menu-pill-btn">
                        <ion-icon name="cash"></ion-icon> Earnings
                    </a>
                </div>
            </div>

            <div class="dashboard-content">
                <div style="text-align:left; margin-bottom:40px;">
                    <h1 style="font-family:'Outfit', sans-serif; font-size:3rem; margin-bottom:12px; margin-top:0;">
                        Menu Item Management</h1>
                    <p style="color:#666; font-size:1.1rem;">Manage your menu by adding new items,
                        editing existing ones,
                        or removing outdated dishes.</p>
                </div>
                <!-- Toolbar -->
                <div class="toolbar"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <h2 style="font-size:1.5rem; margin:0;">Search</h2>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <div class="search-box"><ion-icon name="search-outline"></ion-icon><input type="text"
                                    id="searchInput" onkeyup="searchItems()"
                                    placeholder="Enter Item ID, Name, or Desc...">
                            </div>
                            <div style="position:relative;"><button class="btn-tool"
                                    onclick="toggleDropdown('filterDropdown')"><ion-icon
                                        name="options-outline"></ion-icon>Filter </button>
                                <div id="filterDropdown" class="dropdown-menu" style="width:250px; padding:12px;">
                                    <div style="margin-bottom:8px; font-weight:600; font-size:0.9rem;">
                                        Filter by Group </div>
                                    <div class="dropdown-item" onclick="filterItems('all')">All
                                        Groups</div>
                                    <div id="dynamicFilterOptions"></div>
                                    <hr style="border:0; border-top:1px solid #eee; margin:8px 0;">
                                    <div style="margin-bottom:8px; font-weight:600; font-size:0.9rem;">
                                        Filter by Variation </div>
                                    <div class="dropdown-item" onclick="filterByVariation('')">All Variations</div>
                                    <div class="dropdown-item" onclick="filterByVariation('size')">Has Size Variations
                                    </div>
                                    <div class="dropdown-item" onclick="filterByVariation('spice')">Has Spice Variations
                                    </div>
                                    <div class="dropdown-item" onclick="filterByVariation('custom')">Has Custom Options
                                    </div>
                                    <hr style="border:0; border-top:1px solid #eee; margin:8px 0;">
                                    <div style="margin-bottom:8px; font-weight:600; font-size:0.9rem;">
                                        Filter by Price </div>
                                    <div style="display:flex; gap:8px; margin-bottom:8px;"><input type="number"
                                            id="filterMinPrice" placeholder="Min"
                                            style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px;"><input
                                            type="number" id="filterMaxPrice" placeholder="Max"
                                            style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px;">
                                    </div><button class="btn-gold" style="width:100%; padding:6px; font-size:0.8rem;"
                                        onclick="applyAdvancedFilter()">Apply Filters</button>
                                </div>
                            </div>
                            <!-- <button id="btnResetData" class="btn-tool"
                                style="color:red; border-color:red; margin-right:8px;"><ion-icon
                                    name="refresh-outline"></ion-icon>Reset Data </button> -->
                            <div style="position:relative;"><button class="btn-tool"
                                    onclick="toggleDropdown('bulkDropdown')"><ion-icon
                                        name="create-outline"></ion-icon>Edit
                                </button>
                                <!-- Bulk Action Dropdown with Group Popover -->
                                <div id="bulkDropdown" class="dropdown-menu">
                                    <div class="dropdown-item" onclick="openConfirmationModal('delete')"><ion-icon
                                            name="trash-outline"></ion-icon>Delete Item (s)
                                    </div>
                                    <div style="position:relative;">
                                        <div class="dropdown-item" onclick="openGroupPopover(event)"><ion-icon
                                                name="people-outline"></ion-icon>Group Item (s)
                                            <ion-icon name="chevron-forward-outline"
                                                style="margin-left:auto; font-size:0.8rem;"></ion-icon>
                                        </div>
                                        <!-- Group Popover Sub-menu -->
                                        <div id="groupPopover" class="group-popover">
                                            <div id="groupList">
                                                <!-- Dynamic Groups -->
                                                <div class="dropdown-item group-item"
                                                    style="border-top:1px solid #FFD54F; margin-top:4px; font-weight:600;"
                                                    onclick="showNewGroupForm(event)">
                                                    New Group </div>
                                            </div>
                                            <div id="newGroupForm" style="display:none; padding:8px;"><label
                                                    style="font-size:0.8rem; font-weight:600; display:block; margin-bottom:4px;">New
                                                    group</label><input type="text"
                                                    placeholder="Enter New Group Name: Signature"
                                                    style="width:100%; padding:6px; margin-bottom:8px; border-radius:4px; border:1px solid #ddd;">
                                                <div style="display:flex; gap:4px;"><button class="btn-gold"
                                                        style="padding:4px 8px; font-size:0.7rem;"
                                                        onclick="addNewGroup()">Add As New
                                                        Group</button><button class="btn-gold"
                                                        style="padding:4px 8px; font-size:0.7rem; background:#FFF3E0; border:1px solid #FFC107;">Re-Group</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-item" onclick="openEditModal()">
                                        <ion-icon name="create-outline"></ion-icon>Edit Item (s)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="align-self: flex-end; display: flex; gap: 12px; align-items: center;">
                        <button class="btn-tool" onclick="openAddModal()"><ion-icon name="add"></ion-icon>Add Item
                        </button>
                    </div>
                </div>
                <!-- Main Content Table -->
                <div style="overflow-x:auto;">
                    <table id="menuTable" class="custom-table">
                        <thead>
                            <tr>
                                <th style="width:50px;">
                                    <div class="checkbox-sq"></div>
                                </th>
                                <th>Item ID</th>
                                <th style="cursor:pointer;" onclick="sortItems('name')">Name
                                    <ion-icon name="swap-vertical-outline"></ion-icon>
                                </th>
                                <th style="cursor:pointer;" onclick="sortItems('price')">Price
                                    <ion-icon name="swap-vertical-outline"></ion-icon>
                                </th>
                                <th>Group</th>
                                <th>Ingredients</th>
                                <th>Description</th>
                                <th>Dietary Notes</th>
                            </tr>
                        </thead>
                        <tbody id="menuTableBody">
                            <!-- Items will be loaded here from Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- End Content Area -->
        </div>
        <!-- Add Item Modal (Yellow Theme) -->
        <div id="addModal" class="modal-overlay">
            <div class="modal-form-card" style="position:relative;"><span class="close-icon"
                    onclick="closeModal('addModal')" style="top:20px; right:20px;">&times;
                </span>
                <h2 style="text-align:center; margin-bottom:24px; font-size:2rem; font-family:'Outfit',serif;">Add
                    New Item </h2>
                <div class="form-row"><label>New Item ID:</label><input type="text" id="addId"
                        placeholder="Enter Item ID.."></div>
                <div class="form-row"><label>Image Path:</label>
                    <div style="flex:1; display:flex; gap:8px;"><input type="text" id="addImage"
                            placeholder="../images/filename.jpg" style="flex:1;"><input type="file" id="addFileHelper"
                            accept="image/*" style="display:none;" onchange="handleImageUpload('add', this)"><button
                            class="btn-tool" onclick="document.getElementById('addFileHelper').click()">Select
                            File</button>
                    </div>
                </div>
                <div class="form-row"><label>New Item Name:</label><input type="text" id="addName"
                        placeholder="Enter Name.."></div>
                <div class="form-row"><label>New Item Price:</label><input type="number" id="addPrice"
                        placeholder="Enter Price.."></div>
                <div class="form-row"><label>New Item Cost:</label><input type="number" id="addCost"
                        placeholder="Enter Cost (COGS).."></div>
                <div class="form-row"><label>New Item Group:</label><select id="addGroup">
                        <option value="">Select Group..</option>
                    </select></div>
                <div class="form-row"><label>New Item Ingredients:</label><input type="text" id="addIngredients"
                        placeholder="Enter Ingredients.."></div>
                <div class="form-row"><label>New Item Description:</label><input type="text" id="addDesc"
                        placeholder="Enter Description.."></div>
                <div class="form-row"><label>New Dietary Notes:</label><input type="text" id="addDiet"
                        placeholder="Enter Dietary Notes.."></div>

                <!-- Variants Section -->
                <div class="form-row" style="display:block;">
                    <label>Variants (Optional):</label>
                    <div id="addVariantsContainer" style="margin-top:8px;">
                        <!-- Variant rows will be added here -->
                    </div>
                    <button class="btn-tool" onclick="addVariantRow('add')" style="margin-top:8px; font-size:0.8rem;">+
                        Add
                        Variant</button>
                </div>

                <div style="text-align:right; margin-top:24px;"><button class="btn-gold"
                        onclick="openConfirmationModal('add')">Add Item</button></div>
            </div>
        </div>
        <!-- Edit Item Modal (Yellow Theme) -->
        <div id="editModal" class="modal-overlay">
            <div class="modal-form-card" style="position:relative;"><span class="close-icon"
                    onclick="closeModal('editModal')" style="top:20px; right:20px;">&times;
                </span>
                <h2 style="text-align:center; margin-bottom:24px; font-size:2rem; font-family:'Outfit',serif;">
                    Edit Item </h2>
                <div class="form-row"><label>Item ID:</label><input type="text" id="editId"
                        placeholder="Enter Item ID.." disabled style="background:#f0f0f0;"></div>
                <div class="form-row"><label>Image Path:</label>
                    <div style="flex:1; display:flex; gap:8px;"><input type="text" id="editImage"
                            placeholder="../images/filename.jpg" style="flex:1;"><input type="file" id="editFileHelper"
                            accept="image/*" style="display:none;" onchange="handleImageUpload('edit', this)"><button
                            class="btn-tool" onclick="document.getElementById('editFileHelper').click()">Select
                            File</button>
                    </div>
                </div>
                <div class="form-row"><label>New Item Name:</label><input type="text" id="editName"
                        placeholder="Enter Name.."></div>
                <div class="form-row"><label>New Item Price:</label><input type="number" id="editPrice"
                        placeholder="Enter Price.."></div>
                <div class="form-row"><label>New Item Cost:</label><input type="number" id="editCost"
                        placeholder="Enter Cost (COGS).."></div>
                <div class="form-row"><label>New Item Group:</label><select id="editGroup">
                        <option value="">Select Group..</option>
                    </select></div>
                <div class="form-row"><label>New Item Ingredients:</label><input type="text" id="editIngredients"
                        placeholder="Enter Ingredients.."></div>
                <div class="form-row"><label>New Item Description:</label><input type="text" id="editDesc"
                        placeholder="Enter Description.."></div>
                <div class="form-row"><label>New Dietary Notes:</label><input type="text" id="editDiet"
                        placeholder="Enter Dietary Notes.."></div>

                <!-- Variants Section -->
                <div class="form-row" style="display:block;">
                    <label>Variants (Optional):</label>
                    <div id="editVariantsContainer" style="margin-top:8px;">
                        <!-- Variant rows will be added here -->
                    </div>
                    <button class="btn-tool" onclick="addVariantRow('edit')" style="margin-top:8px; font-size:0.8rem;">+
                        Add
                        Variant</button>
                </div>

                <div style="text-align:right; margin-top:24px;"><button class="btn-gold"
                        onclick="openConfirmationModal('edit')">Update Item</button></div>
            </div>
        </div>
        <!-- Confirmation Modal (White Theme) -->
        <div id="confirmModal" class="modal-overlay">
            <div class="modal-confirm-card"><span class="close-icon" onclick="closeModal('confirmModal')">&times;
                </span>
                <div style="text-align:center;">
                    <h3 id="confirmTitle" style="font-size:1.5rem; margin-bottom:32px; font-family:'Outfit',serif;">Are
                        you
                        sure you want<br>to edit item?</h3>
                    <div style="display:flex; justify-content:center; gap:16px;"><button class="btn-gold"
                            onclick="handleConfirm()">Confirm</button><button class="btn-gold"
                            style="background:#FFD54F;" onclick="closeModal('confirmModal')">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        <style>
            body {
                background-color: #FFF8E1;
                font-family: 'Outfit', sans-serif;
                margin: 0;
            }

            .toolbar h2 {
                font-weight: 600;
                font-size: 1.2rem;
                margin-bottom: 8px;
            }

            .search-box {
                position: relative;
                background: #FFF8E1;
            }

            .search-box input {
                padding: 10px 10px 10px 36px;
                border-radius: 8px;
                border: 1px solid #ccc;
                /* Visible border */
                background: white;
                width: 250px;
            }

            .search-box ion-icon {
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: #666;
            }

            .btn-tool {
                background: white;
                border: 1px solid #ccc;
                /* Visible border like reference */
                padding: 10px 20px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                font-family: inherit;
                font-weight: 500;
            }

            /* Dropdown */
            .dropdown-menu {
                position: absolute;
                top: 100%;
                left: 0;
                background: #FFF8E1;
                border: 1px solid #FFC107;
                border-radius: 12px;
                padding: 8px;
                width: 200px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                display: none;
                z-index: 100;
                margin-top: 8px;
            }

            .dropdown-item {
                padding: 12px;
                display: flex;
                align-items: center;
                gap: 12px;
                cursor: pointer;
                border-radius: 8px;
                font-size: 0.9rem;
            }

            .dropdown-item:hover {
                background: rgba(255, 193, 7, 0.2);
            }

            /* Custom Table */
            .custom-table {
                width: 100%;
                border-collapse: collapse;
                background: white;
                border: 1px solid #ccc;
            }

            .custom-table th,
            .custom-table td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #eee;
                vertical-align: middle;
                border-right: 1px solid #eee;
                /* Column dividers */
                font-size: 0.9rem;
            }

            .custom-table th {
                font-weight: 600;
                color: #333;
                background: white;
                /* Header white as per reference */
            }

            .checkbox-sq {
                width: 20px;
                height: 20px;
                background: #FFF8E1;
                /* Light yellow */
                border: 1px solid #FFD54F;
                border-radius: 4px;
                cursor: pointer;
            }

            .checkbox-sq.checked {
                background: #FFC107;
                position: relative;
            }

            .checkbox-sq.checked::after {
                content: '‚úì';
                color: black;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 14px;
            }

            /* Modal Styles */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            /* Edit Modal (Yellow) */
            .modal-form-card {
                background: #FFF8E1;
                padding: 40px;
                border-radius: 16px;
                width: 600px;
                max-width: 90%;
                border: 1px solid #e0e0e0;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }

            .form-row {
                display: flex;
                align-items: center;
                margin-bottom: 16px;
                background: #FFF8E1;
            }

            .form-row label {
                width: 180px;
                font-weight: 700;
                font-size: 1rem;
            }

            .form-row input,
            .form-row select {
                flex: 1;
                padding: 12px;
                border-radius: 8px;
                border: none;
                background: white;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }

            /* Confirm Modal (White) */
            .modal-confirm-card {
                background: white;
                padding: 40px;
                border-radius: 16px;
                width: 450px;
                position: relative;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                border: 1px solid #eee;
            }

            .btn-gold {
                background: #FFC107;
                border: none;
                padding: 12px 40px;
                border-radius: 8px;
                font-weight: 700;
                cursor: pointer;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }

            .close-icon {
                position: absolute;
                top: 16px;
                right: 16px;
                font-size: 2rem;
                cursor: pointer;
                color: #999;
            }

            /* Group Popover */
            .group-popover {
                position: absolute;
                top: 0;
                left: 100%;
                width: 200px;
                background: #FFF8E1;
                border: 1px solid #FFC107;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                margin-left: 8px;
                display: none;
                z-index: 101;
            }

            .group-item:hover {
                background: #FFF3E0;
            }
        </style>

        <!-- Custom Context Menu for Promotions -->
        <div id="promotionCtxMenu" class="context-menu">
            <ul id="promoList" style="list-style:none; padding:0; margin:0;">
                <li class="ctx-item" onclick="openConfirmationModal('delete-single')">Delete Item (s)</li>
                <li class="ctx-item" onclick="openGroupAssignmentCtx()">Group Item (s)</li>
                <li class="ctx-item" onclick="openEditModal(true)">Edit Item (s)</li>
                <li class="ctx-item" onclick="removePromotion()" style="font-weight:600; color:#E53935;">
                    Remove Promotion
                </li>
                <li style="border-top:1px solid #FFD54F; margin: 4px 0;"></li>
                <!-- Dynamic Promotions Inserted Here -->
                <li class="ctx-item" onclick="showPromoForm(event)" style="font-weight:600; color:#B08D55;">
                    Add New Promotion
                </li>
            </ul>
            <!-- Add Promo Form (Inside Context Menu or replacing list) -->
            <div id="addPromoForm" style="display:none; padding:8px;">
                <h4 style="margin:0 0 8px 0; font-size:0.9rem;">Add New Promotion</h4>
                <div style="margin-bottom:8px;">
                    <label style="font-size:0.75rem; display:block;">Enter New Promotion Name</label>
                    <input type="text" id="newPromoName" value="New Years Discount"
                        style="width:100%; padding:4px; font-size:0.8rem; border:1px solid #ddd; border-radius:4px;">
                </div>
                <div style="margin-bottom:8px;">
                    <label style="font-size:0.75rem; display:block;">Enter Promotion Amount</label>
                    <div style="display:flex; align-items:center;">
                        <input type="number" id="newPromoAmount" value="15"
                            style="width:50px; padding:4px; font-size:0.8rem; border:1px solid #ddd; border-radius:4px;">
                        <span style="margin-left:4px; font-weight:bold;">%</span>
                    </div>
                </div>
                <button class="btn-gold" onclick="submitPromotion()"
                    style="width:100%; padding:6px; font-size:0.8rem;">Add</button>
            </div>
        </div>

        <!-- Generic Success Modal -->
        <div id="successModal" class="modal-overlay">
            <div class="modal-confirm-card" style="width:350px; padding:24px;">
                <span class="close-icon" onclick="closeModal('successModal')">&times;</span>
                <div style="text-align:center;">
                    <h3 id="successTitle"
                        style="font-size:1.4rem; margin-top:16px; margin-bottom:16px; font-family:'Outfit',serif;">
                        Success!
                    </h3>
                    <div id="successContent"
                        style="background:#FFF8E1; padding:12px; border-radius:8px; margin-bottom:16px; display:none;">
                        <div id="successSubtitle" style="font-weight:bold; color:#B08D55; font-size:0.9rem;"></div>
                        <div id="successMessage" style="font-size:1.1rem; font-weight:700;"></div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            /* Context Menu */
            .context-menu {
                position: absolute;
                background: #FFF8E1;
                border: 1px solid #FFC107;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                width: 200px;
                z-index: 1000;
                display: none;
                overflow: hidden;
                padding: 8px 0;
            }

            .ctx-item {
                padding: 8px 16px;
                font-size: 0.85rem;
                cursor: pointer;
                color: #333;
                display: flex;
                align-items: center;
            }

            .ctx-item:hover {
                background: #FFF3E0;
            }

            .promo-badge {
                background: #FFF3E0;
                margin: 4px 8px;
                border-radius: 4px;
                text-align: center;
                justify-content: center;
                font-weight: 500;
                color: #5d4037;
            }
        </style>

        <script>
            // State management
            let currentAction = '';
            let currentItem = '';

            function toggleDropdown(id) {
                const el = document.getElementById(id);
                const dropdowns = document.getElementsByClassName("dropdown-menu");
                for (let i = 0; i < dropdowns.length; i++) {
                    if (dropdowns[i].id !== id) dropdowns[i].style.display = 'none';
                }
                el.style.display = (el.style.display === 'block') ? 'none' : 'block';
            }

            // --- Context Menu Logic ---
            document.addEventListener('contextmenu', function (e) {
                const row = e.target.closest('tbody tr');
                if (row) {
                    e.preventDefault();
                    // Capture the ID from the row
                    currentItem = row.getAttribute('data-id');
                    showContextMenu(e.pageX, e.pageY);
                }
            });

            document.addEventListener('click', function (e) {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenu();
                }
            });

            function showContextMenu(x, y) {
                const menu = document.getElementById('promotionCtxMenu');
                menu.style.display = 'block';
                menu.style.left = x + 'px';
                menu.style.top = y + 'px';

                document.getElementById('promoList').style.display = 'block';
                document.getElementById('addPromoForm').style.display = 'none';
            }

            function hideContextMenu() {
                document.getElementById('promotionCtxMenu').style.display = 'none';
            }

            // onSnapshot listeners moved to module script

            function openGroupPopover(event) {
                const popover = document.getElementById('groupPopover');
                if (popover.style.display === 'block') {
                    popover.style.display = 'none';
                } else {
                    popover.style.display = 'block';
                    document.getElementById('groupList').style.display = 'block';
                    document.getElementById('newGroupForm').style.display = 'none';
                }
                event.stopPropagation();
            }

            function showNewGroupForm(event) {
                event.stopPropagation();
                document.getElementById('groupList').style.display = 'none';
                document.getElementById('newGroupForm').style.display = 'block';
            }

            function showPromoForm(e) {
                e.stopPropagation();
                document.getElementById('promoList').style.display = 'none';
                document.getElementById('addPromoForm').style.display = 'block';
            }

            // ... Modals ...
            function openAddModal() {
                document.getElementById('addModal').style.display = 'flex';
            }

            function openEditModal(isSingle = false) {
                let targetId = '';
                const checkedBoxes = document.querySelectorAll('.checkbox-sq.checked');

                if (isSingle) {
                    hideContextMenu();
                    targetId = currentItem;
                } else {
                    // If opened via toolbar Edit, use selection
                    if (checkedBoxes.length === 0) {
                        alert("Please select an item to edit.");
                        return;
                    }

                    // If Bulk Group Assignment, we allow multiple
                    // But if genuine Edit, we might restrict to one, OR allow bulk group edit.
                    // For now, if multiple, we only preload common data (like Group).

                    targetId = checkedBoxes[0].getAttribute('data-id');
                    const bulkDropdown = document.getElementById('bulkDropdown');
                    if (bulkDropdown) bulkDropdown.style.display = 'none';

                    // Close Filter Dropdown too if open
                    if (document.getElementById('filterDropdown')) document.getElementById('filterDropdown').style.display = 'none';
                }

                currentAction = isSingle ? 'edit-single' : (checkedBoxes.length > 1 ? 'bulk-edit' : 'edit-single');
                currentItem = targetId;

                // Populate Data (Only if single item is primary target)
                if (targetId && window.menuItemsCache && window.menuItemsCache[targetId]) {
                    const data = window.menuItemsCache[targetId];
                    document.getElementById('editId').value = targetId;

                    // If multiple items, clear specific fields to avoid overwriting unique data with one item's data
                    if (checkedBoxes.length > 1) {
                        document.getElementById('editName').value = '(Multiple Items Selected)';
                        document.getElementById('editName').disabled = true;
                        document.getElementById('editPrice').value = '';
                        document.getElementById('editPrice').disabled = true;
                        document.getElementById('editCost').value = '';
                        document.getElementById('editCost').disabled = true;
                        document.getElementById('editImage').value = '';
                        document.getElementById('editIngredients').value = '';
                        document.getElementById('editDesc').value = '';
                        document.getElementById('editDiet').value = '';
                        // Group remains editable
                        document.getElementById('editGroup').value = data.category || '';
                    } else {
                        document.getElementById('editName').disabled = false;
                        document.getElementById('editPrice').disabled = false;
                        document.getElementById('editCost').disabled = false;
                        document.getElementById('editName').value = data.name || '';
                        document.getElementById('editPrice').value = data.price || '';
                        document.getElementById('editCost').value = data.cost || '';
                        document.getElementById('editGroup').value = data.category || '';
                        document.getElementById('editIngredients').value = data.ingredients || '';
                        document.getElementById('editDesc').value = data.description || '';
                        document.getElementById('editDiet').value = data.dietary || '';
                        document.getElementById('editImage').value = data.imageUrl || '';

                        // Populate Variants
                        const variantContainer = document.getElementById('editVariantsContainer');
                        variantContainer.innerHTML = ''; // Clear previous
                        if (data.variants && Array.isArray(data.variants)) {
                            data.variants.forEach(v => window.addVariantRow('edit', v));
                        }
                    }
                }

                document.getElementById('editModal').style.display = 'flex';
            }

            function openConfirmationModal(action) {
                // Check if validation passes for Add/Edit before verifying?
                // For now, simple confirmation
                currentAction = action;
                const modal = document.getElementById('confirmModal');
                const title = document.getElementById('confirmTitle');

                if (action === 'add') {
                    title.innerHTML = 'Are you sure you want<br>to add item?';
                } else if (action === 'edit' || action === 'edit-single') {
                    title.innerHTML = 'Are you sure you want<br>to update item?';
                } else if (action === 'delete' || action === 'delete-single') {
                    title.innerHTML = 'Are you sure you want<br>to delete item?';
                } else if (action === 'remove-promo') {
                    title.innerHTML = 'Do you want to remove<br>this promo from this menu?';
                }

                // Hide context menu if open
                hideContextMenu();

                modal.style.display = 'flex';
                document.getElementById('bulkDropdown').style.display = 'none';
                document.getElementById('addModal').style.display = 'none';
                document.getElementById('editModal').style.display = 'none';
            }

            async function handleConfirm() {
                closeModal('confirmModal');

                if (currentAction === 'add') {
                    if (window.confirmAddItem) await window.confirmAddItem();
                } else if (currentAction === 'delete' || currentAction === 'delete-single') {
                    // Both bulk and single delete use confirmDelete (logic inside handles distinction)
                    if (window.confirmDelete) await window.confirmDelete();
                } else if (currentAction === 'edit' || currentAction === 'edit-single') {
                    if (window.confirmEdit) await window.confirmEdit();
                } else if (currentAction === 'remove-promo') {
                    if (window.confirmRemovePromo) await window.confirmRemovePromo();
                } else {
                    showSuccessModal('Action Confirmed!', 'Success', 'The operation was completed.');
                }
            }

            // Confirm Remove Promotion (Logic)
            window.confirmRemovePromo = async () => {
                const targetId = currentItem;
                if (!targetId) return;

                try {
                    const itemRef = doc(db, "menu_items", targetId);
                    await updateDoc(itemRef, {
                        promotion: deleteField()
                    });

                    // if(typeof hideContextMenu === 'function') hideContextMenu();
                    window.showSuccessModal('Promotion Removed!', 'Promotion', 'The promotion from this item has been removed.');
                } catch (error) {
                    console.error("Error removing promo:", error);
                    alert("Failed to remove promotion: " + error.message);
                }
            };

            // Remove Promotion Trigger (UI)
            window.removePromotion = () => {
                const targetId = currentItem;
                if (!targetId) {
                    alert("No item selected.");
                    return;
                }
                openConfirmationModal('remove-promo');
            };

            function showSuccessModal(title, subtitle = '', message = '') {
                const modal = document.getElementById('successModal');
                document.getElementById('successTitle').innerHTML = title;

                const contentDiv = document.getElementById('successContent');
                if (subtitle || message) {
                    contentDiv.style.display = 'block';
                    document.getElementById('successSubtitle').innerText = subtitle;
                    document.getElementById('successMessage').innerText = message;
                } else {
                    contentDiv.style.display = 'none';
                }

                modal.style.display = 'flex';
            }

            // ===== VARIATION FILTER =====
            window.filterByVariation = () => {
                const filterValue = document.getElementById('variationFilter').value;
                const table = $('#menuTable').DataTable();

                if (!filterValue) {
                    table.search('').draw();
                    return;
                }

                // Filter based on variation type
                let searchTerm = '';
                switch (filterValue) {
                    case 'size':
                        searchTerm = 'size|Size|SIZE';
                        break;
                    case 'spice':
                        searchTerm = 'spice|Spice|SPICE|spicy|Spicy|SPICY';
                        break;
                    case 'custom':
                        searchTerm = 'custom|Custom|CUSTOM|option|Option';
                        break;
                }

                // Use DataTables regex search
                table.search(searchTerm, true, false).draw();
            };

            function closeModal(id) {
                document.getElementById(id).style.display = 'none';
            }

            window.onclick = function (event) {
                if (!event.target.closest('.btn-tool') && !event.target.closest('.dropdown-menu') && !event.target.closest('.group-popover-content')) {
                    const dropdowns = document.getElementsByClassName("dropdown-menu");
                    for (let i = 0; i < dropdowns.length; i++) {
                        dropdowns[i].style.display = 'none';
                    }
                    const popovers = document.getElementsByClassName("group-popover");
                    for (let j = 0; j < popovers.length; j++) {
                        popovers[j].style.display = 'none';
                    }
                }
            }
        </script>
        <script src="../js/navbar.js"></script>
        <script src="../js/responsive.js"></script>
</body>

</html>