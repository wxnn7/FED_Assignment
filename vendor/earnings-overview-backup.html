<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earnings Overview - Digital Hawker</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/vendor.css?v=2">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="../js/auth-check.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Dashboard Styles Reuse */
        .dashboard-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            border-radius: 12px;
            background: var(--primary-color);
            color: var(--text-dark);
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            justify-content: center;
        }

        .dashboard-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        /* Analytics Specific Styles */
        /* Analytics Specific Styles - Updated to match Sidebar Pills */
        .analytics-nav .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #FFC107;
            /* Darker Yellow Default */
            color: black;
            font-weight: 600;
            padding: 10px 24px;
            cursor: pointer;
            border-radius: 50px;
            border: none;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .analytics-nav .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .analytics-nav .btn.active {
            background: #FFE082;
            /* Lighter Yellow Active */
            color: black;
            font-weight: 700;
            border: 2px solid #FFC107;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .view-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view-section.active {
            display: block;
        }

        .profit-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-bottom: 24px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .profit-table th {
            text-align: left;
            padding: 12px;
            background: #eee;
            font-weight: 600;
        }

        .profit-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .total-box {
            background: white;
            padding: 16px;
            text-align: right;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }

        /* Responsive Layout */
        .analytics-layout {
            display: flex;
            gap: 24px;
            flex-direction: column;
        }
    </style>


    <script>function toggleMobileNav() {
            const container = document.getElementById('navLinksContainer');
            container.classList.toggle('show');
        }

    </script>
</head>

<body>
    <!-- Consumer Style Header -->
    <header class="preview-header"
        style="background:#FFF8E1; padding: 20px 40px; display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center; gap:12px;"><a href="dashboard.html"
                style="text-decoration:none; display:block;">
                <div
                    style="width:50px; height:50px; background:url('../images/main_logo.png') center/contain no-repeat; border-radius:50%;">
                </div>
            </a></div>
        <nav class="nav-links" style="display:flex; gap:32px;"><a href="dashboard.html"
                style="text-decoration:none; color:#333; font-weight:500; font-size:0.9rem;">Home</a><a
                href="orders.html"
                style="text-decoration:none; color:#333; font-weight:500; font-size:0.9rem;">Order</a><a href="#"
                style="text-decoration:none; color:#333; font-weight:500; font-size:0.9rem;">Order History</a><a
                href="#" style="text-decoration:none; color:#333; font-weight:500; font-size:0.9rem;">Contact Us</a>
        </nav>
        <div style="display:flex; align-items:center; gap:20px;">
            <div style="position:relative;"><ion-icon name="notifications" style="font-size:1.5rem; cursor:pointer;"
                    onclick="toggleNotifications()"></ion-icon>
                <div id="notifDropdown"
                    style="display:none; position:absolute; top:40px; right:0; width:300px; background:white; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.1); border:1px solid #eee; z-index:100; overflow:hidden; color:black; text-align:left;">
                    <div style="padding:16px; border-bottom:1px solid #eee; font-weight:600;">Notifications
                    </div>
                    <div style="max-height:300px; overflow-y:auto;">
                        <div style="padding:12px 16px; border-bottom:1px solid #f9f9f9;">
                            <div style="font-size:0.9rem; font-weight:600;">Table 04 Occupied</div>
                            <div style="font-size:0.8rem; color:#666;">Alice Tan just seated.</div>
                        </div>
                    </div>
                    <div style="padding:12px; text-align:center; border-top:1px solid #eee;"><a href="dashboard.html"
                            style="font-size:0.8rem; color:var(--primary-color); text-decoration:none;">View
                            All</a></div>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:8px; cursor:pointer;"
                onclick="window.location.href='settings.html'"><ion-icon name="person"
                    style="font-size:1.5rem;"></ion-icon><span
                    style="font-size:0.9rem; font-weight:500;">Username01</span></div>
        </div>
    </header>
    <div style="width: 100%; padding: 40px 40px; box-sizing: border-box;">
        <div class="split-layout">
            <!-- Left Stack (Sidebar) -->

            <div class="nav-stack" style="position:relative;">
                <button class="mobile-nav-toggle" onclick="toggleMobileNav()">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <ion-icon name="restaurant"></ion-icon> Menu
                    </div>
                    <ion-icon name="chevron-down-outline"></ion-icon>
                </button>

                <div class="nav-links-container" id="navLinksContainer">
                    <a href="dashboard.html" class="menu-pill-btn">
                        <ion-icon name="grid"></ion-icon> Dashboard
                    </a>
                    <a href="orders.html" class="menu-pill-btn">
                        <ion-icon name="cart"></ion-icon> Orders
                    </a>
                    <a href="menu.html" class="menu-pill-btn">
                        <ion-icon name="restaurant"></ion-icon> Menu
                    </a>
                    <a href="earnings-overview.html" class="menu-pill-btn active">
                        <ion-icon name="cash"></ion-icon> Earnings
                    </a>

                </div>
            </div>
            <!-- Right Panel (Content) -->
            <div class="content-area">
                <div class="analytics-layout">
                    <!-- Top Summary Cards (Optional) -->
                    <!-- Main Analytics View -->
                    <div class="card" style="min-height: 600px;">
                        <div class="analytics-nav"
                            style="display: flex; gap: 20px; border-bottom: 1px solid #eee; padding-bottom: 16px; margin-bottom: 24px; align-items:center; justify-content:space-between;">
                            <h2 style="font-size:1.5rem; margin:0; display:flex; align-items:center; gap:8px;">
                                <ion-icon name="stats-chart-outline"></ion-icon>Reports
                            </h2>
                            <div style="display:flex; gap:12px; overflow-x:auto;">
                                <button class="btn active" onclick="switchView('overview', this)">Earnings
                                    Overview</button>
                                <button class="btn" onclick="switchView('revenue', this)">Revenue Per Item</button>
                                <button class="btn" onclick="switchView('profit', this)">Profit Margin Tracking</button>
                            </div>
                        </div>
                        <div class="analytics-body">
                            <!-- VIEW 1: Earnings Overview -->
                            <div id="overview" class="view-section active">
                                <div
                                    style="text-align:center; margin-bottom:32px; background:#FFF8E1; padding:40px; border-radius:16px;">
                                    <h2 style="font-size:2.5rem; margin-bottom:12px; font-family:'Outfit', serif;">
                                        Earnings Overview</h2>
                                    <p
                                        style="color:#666; font-size:1rem; max-width:600px; margin:0 auto; line-height:1.6;">
                                        Quickly view a summary of your earnings with daily,
                                        weekly,
                                        and seasonal breakdowns,
                                        giving you a clear picture of your overall revenue.</p>
                                </div>
                                <div style="text-align:right; margin-bottom:16px;"><select id="earningsPeriod"
                                        onchange="toggleEarnings(this.value)"
                                        style="padding:10px 24px; border-radius:8px; border:none; background:#FFC107; font-family:'Outfit',sans-serif; font-weight:600; font-size:1rem; cursor:pointer; box-shadow:var(--shadow-sm);">
                                        <option value="weekly">Weekly</option>
                                        <option value="hourly">Hourly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="yearly">Yearly</option>
                                    </select></div>
                                <div class="chart-container"
                                    style="height:500px; padding:24px; border:1px solid #ddd; background:white; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.05);">
                                    <canvas id="earningsChart"></canvas>
                                </div>
                            </div>
                            <!-- VIEW 2: Revenue Per Item -->
                            <div id="revenue" class="view-section">
                                <div class="card"
                                    style="margin-bottom:24px; background:#FFF8E1; padding: 24px; border-radius: 12px;">
                                    <h3 style="margin-top:0;">Revenue Per Item</h3>
                                    <p style="color: #666; margin-bottom: 0;">Check detailed
                                        earnings generated from each product.</p>
                                </div>
                                <!-- Interactive Controls for Revenue -->
                                <div
                                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap:wrap; gap:16px;">
                                    <div style="flex:1;">
                                        <h4 id="revenueTitle" style="margin-bottom:8px; font-size:1.2rem;">
                                            Revenue Main (All Items)</h4>
                                        <p id="revenueSubtitle" style="color:#666; font-size:0.9rem;">
                                            Comparing top performing items over the last
                                            4 weeks.</p>
                                    </div>
                                    <div style="display:flex; gap:12px; align-items:center;">
                                        <select id="itemSelect" onchange="updateRevenueView()"
                                            style="padding:10px 16px; border-radius:8px; border:1px solid #ddd; font-family:'Outfit',sans-serif; min-width:160px;">
                                            <option value="all">All Items</option>
                                        </select>
                                        <!-- Revenue Period Filter --><select id="revenuePeriod"
                                            onchange="updateRevenueView()"
                                            style="padding:9px 12px; border-radius:8px; border:1px solid #ddd; font-family:'Outfit',sans-serif;">
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="chart-container"
                                    style="height:450px; padding:16px; border:1px solid #eee; background:white; border-radius:12px;">
                                    <canvas id="revenueChart"></canvas>
                                </div>
                            </div>
                            <!-- VIEW 3: Profit Margin Tracking -->
                            <div id="profit" class="view-section">
                                <!-- Header Card -->
                                <div class="card"
                                    style="margin-bottom:24px; background:#FFF8E1; padding:24px; border-radius:12px;">
                                    <h3 style="margin-top:0;">Profit Margin Tracking</h3>
                                    <p style="color:#666; margin-bottom:0;">Monitor profit margins by factoring in costs
                                        like ingredients, rent, and other expenses, allowing you to assess the true
                                        profitability of your business.</p>
                                </div>

                                <!-- 1. Ingredients Table -->
                                <div class="card"
                                    style="background:white; padding:24px; border-radius:12px; margin-bottom:24px;">
                                    <div
                                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                        <h3 style="margin:0;">Ingredients</h3>
                                        <select id="ingredientsFilter" onchange="updateIngredientsTable()"
                                            style="padding:6px 12px; border:1px solid #ddd; border-radius:6px; background:#FFC107; color:black; font-weight:500; cursor:pointer;">
                                            <option value="monthly" selected>Monthly</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="daily">Daily</option>
                                        </select>
                                    </div>
                                    <div style="overflow-x:auto;">
                                        <table id="ingredientsTable" class="custom-table">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th style="text-align:right;">Price / Quantity</th>
                                                    <th style="text-align:right;">Quantity</th>
                                                    <th style="text-align:right;">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody id="ingredientsBody">
                                                <tr>
                                                    <td>Cooking Oil</td>
                                                    <td style="text-align:right;">$ 3.21 / liter</td>
                                                    <td style="text-align:right;">60</td>
                                                    <td style="text-align:right;">$ 192.60</td>
                                                </tr>
                                                <tr>
                                                    <td>Noodles</td>
                                                    <td style="text-align:right;">$ 4.57 / pack</td>
                                                    <td style="text-align:right;">100</td>
                                                    <td style="text-align:right;">$ 457.00</td>
                                                </tr>
                                                <tr>
                                                    <td>Prawns</td>
                                                    <td style="text-align:right;">$ 9.84 / kilogram</td>
                                                    <td style="text-align:right;">45</td>
                                                    <td style="text-align:right;">$ 442.80</td>
                                                </tr>
                                                <tr>
                                                    <td>Eggs</td>
                                                    <td style="text-align:right;">$ 4.43 / dozen</td>
                                                    <td style="text-align:right;">200</td>
                                                    <td style="text-align:right;">$ 886.00</td>
                                                </tr>
                                                <tr>
                                                    <td>Bean Sprout</td>
                                                    <td style="text-align:right;">$ 3.57 / kilogram</td>
                                                    <td style="text-align:right;">80</td>
                                                    <td style="text-align:right;">$ 285.60</td>
                                                </tr>
                                                <tr>
                                                    <td>Flour</td>
                                                    <td style="text-align:right;">$ 3.17 / kilogram</td>
                                                    <td style="text-align:right;">40</td>
                                                    <td style="text-align:right;">$ 126.80</td>
                                                </tr>
                                                <tr>
                                                    <td>Chili</td>
                                                    <td style="text-align:right;">$ 7.30 / kilogram</td>
                                                    <td style="text-align:right;">30</td>
                                                    <td style="text-align:right;">$ 219.00</td>
                                                </tr>
                                                <tr>
                                                    <td>Crab Garlic</td>
                                                    <td style="text-align:right;">$ 5.53 / kilogram</td>
                                                    <td style="text-align:right;">40</td>
                                                    <td style="text-align:right;">$ 221.20</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div
                                        style="text-align:right; margin-top:16px; padding:12px; background:#f9f9f9; border-radius:8px; font-weight:600;">
                                        Total: <span style="color:#F44336; font-size:1.1rem;">$ 2,831.00</span>
                                    </div>
                                </div>

                                <!-- 2. Rent Type Table -->
                                <div class="card"
                                    style="background:white; padding:24px; border-radius:12px; margin-bottom:24px;">
                                    <div
                                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                        <h3 style="margin:0;">Rent Type</h3>
                                    </div>
                                    <div style="overflow-x:auto;">
                                        <table id="rentTable" class="custom-table">
                                            <thead>
                                                <tr>
                                                    <th>Rent Type</th>
                                                    <th>Date Renewed</th>
                                                    <th>Date Expiry</th>
                                                    <th style="text-align:right;">Price / Month</th>
                                                    <th style="text-align:right;">Price After GST</th>
                                                </tr>
                                            </thead>
                                            <tbody id="rentBody">
                                                <tr>
                                                    <td>Electricity</td>
                                                    <td>1 January 2024 (12 : 00 : 00)</td>
                                                    <td>31 January 2024 (12 : 00 : 00)</td>
                                                    <td style="text-align:right;">$ 210.89</td>
                                                    <td style="text-align:right;">$ 236.35</td>
                                                </tr>
                                                <tr>
                                                    <td>Water</td>
                                                    <td>1 January 2024 (12 : 00 : 00)</td>
                                                    <td>31 January 2024 (12 : 00 : 00)</td>
                                                    <td style="text-align:right;">$ 90.87</td>
                                                    <td style="text-align:right;">$ 101.88</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div
                                        style="text-align:right; margin-top:16px; padding:12px; background:#f9f9f9; border-radius:8px; font-weight:600;">
                                        Total: <span style="color:#F44336; font-size:1.1rem;">$ 338.23</span>
                                    </div>
                                </div>

                                <!-- 3. Bill Type Table -->
                                <div class="card"
                                    style="background:white; padding:24px; border-radius:12px; margin-bottom:24px;">
                                    <div
                                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                        <h3 style="margin:0;">Bill Type</h3>
                                    </div>
                                    <div style="overflow-x:auto;">
                                        <table id="billsTable" class="custom-table">
                                            <thead>
                                                <tr>
                                                    <th>Bill Type</th>
                                                    <th>From</th>
                                                    <th>To</th>
                                                    <th style="text-align:right;">Price / Month</th>
                                                    <th style="text-align:right;">Price After GST</th>
                                                </tr>
                                            </thead>
                                            <tbody id="billsBody">
                                                <tr>
                                                    <td>Electricity</td>
                                                    <td>1 January 2024 (12 : 00 : 00)</td>
                                                    <td>31 January 2024 (12 : 00 : 00)</td>
                                                    <td style="text-align:right;">$ 210.89</td>
                                                    <td style="text-align:right;">$ 236.35</td>
                                                </tr>
                                                <tr>
                                                    <td>Water</td>
                                                    <td>1 January 2024 (12 : 00 : 00)</td>
                                                    <td>31 January 2024 (12 : 00 : 00)</td>
                                                    <td style="text-align:right;">$ 90.87</td>
                                                    <td style="text-align:right;">$ 101.88</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div
                                        style="text-align:right; margin-top:16px; padding:12px; background:#f9f9f9; border-radius:8px; font-weight:600;">
                                        Total: <span style="color:#F44336; font-size:1.1rem;">$ 338.23</span>
                                    </div>
                                </div>

                                <!-- 4. Employee / Payroll Table -->
                                <div class="card"
                                    style="background:white; padding:24px; border-radius:12px; margin-bottom:24px;">
                                    <div
                                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                        <h3 style="margin:0;">Employee Payroll</h3>
                                    </div>
                                    <div style="overflow-x:auto;">
                                        <table id="payrollTable" class="custom-table">
                                            <thead>
                                                <tr>
                                                    <th>Employee ID</th>
                                                    <th>Wage Type</th>
                                                    <th style="text-align:right;">Per Month</th>
                                                    <th style="text-align:right;">Per Hour</th>
                                                    <th style="text-align:right;">Hours</th>
                                                    <th style="text-align:right;">Total / Month</th>
                                                </tr>
                                            </thead>
                                            <tbody id="payrollBody">
                                                <tr>
                                                    <td>S123456A</td>
                                                    <td>Monthly</td>
                                                    <td style="text-align:right;">$ 2500.00</td>
                                                    <td style="text-align:right;">-</td>
                                                    <td style="text-align:right;">176</td>
                                                    <td style="text-align:right;">$ 2500.00</td>
                                                </tr>
                                                <tr>
                                                    <td>S234567B</td>
                                                    <td>Hourly</td>
                                                    <td style="text-align:right;">-</td>
                                                    <td style="text-align:right;">$ 8.00</td>
                                                    <td style="text-align:right;">120</td>
                                                    <td style="text-align:right;">$ 960.00</td>
                                                </tr>
                                                <tr>
                                                    <td>S345678C</td>
                                                    <td>Monthly</td>
                                                    <td style="text-align:right;">$ 2200.00</td>
                                                    <td style="text-align:right;">-</td>
                                                    <td style="text-align:right;">176</td>
                                                    <td style="text-align:right;">$ 2200.00</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div
                                        style="text-align:right; margin-top:16px; padding:12px; background:#f9f9f9; border-radius:8px; font-weight:600;">
                                        Total: <span style="color:#F44336; font-size:1.1rem;">$ 5,660.00</span>
                                    </div>
                                </div>

                                <!-- Summary Card -->
                                <div class="card" style="background:white; padding:24px; border-radius:12px;">
                                    <h3 style="margin-top:0;">Summary</h3>
                                    <table class="custom-table" style="margin-bottom:0;">
                                        <tbody>
                                            <tr>
                                                <td style="font-weight:600;">Total Revenue</td>
                                                <td style="text-align:right; color:#2E7D32; font-weight:600;">$
                                                    18,000.00</td>
                                            </tr>
                                            <tr>
                                                <td>Ingredients Cost</td>
                                                <td style="text-align:right; color:#F44336;">$ 2,831.00</td>
                                            </tr>
                                            <tr>
                                                <td>Rent & Utilities</td>
                                                <td style="text-align:right; color:#F44336;">$ 338.23</td>
                                            </tr>
                                            <tr>
                                                <td>Bills</td>
                                                <td style="text-align:right; color:#F44336;">$ 338.23</td>
                                            </tr>
                                            <tr>
                                                <td>Payroll</td>
                                                <td style="text-align:right; color:#F44336;">$ 5,660.00</td>
                                            </tr>
                                            <tr style="border-top:2px solid #eee;">
                                                <td style="font-size:1.2rem; font-weight:700;">Net Profit</td>
                                                <td
                                                    style="text-align:right; font-size:1.2rem; font-weight:700; color:#2E7D32;">
                                                    $ 8,832.54</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>




                            </h3>
                            <p style="color: #666; margin-bottom: 0;">Monitor
                                profit margins by factoring in costs like
                                ingredients,
                                rent,
                                and other expenses.</p>
                        </div>
                        <!-- 1. Ingredients Table -->
                        <div
                            style="background:white; padding:24px; border-radius:12px; box-shadow:var(--shadow-sm); margin-bottom:24px;">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <h3 style="margin:0;">Ingredients</h3>
                                    <div style="position:relative;"><select id="ingredientsFilter"
                                            onchange="updateIngredientsTable()"
                                            style="padding:6px 12px; border:1px solid #ddd; border-radius:6px; background:#FFC107; color:black; font-weight:500; cursor:pointer;">
                                            <option value="daily">Daily
                                            </option>
                                            <option value="weekly">Weekly
                                            </option>
                                            <option value="monthly" selected>Monthly</option>
                                            <option value="yearly">Yearly
                                            </option>
                                        </select></div>
                                </div>
                                <div style="display:flex; gap:8px;"><button class="btn" onclick="seedData()"
                                        style="background:#FFC107; font-size:0.8rem; padding:6px 12px; font-weight:600;">Seed
                                        Orders</button><button class="btn" onclick="seedItemCosts()"
                                        style="background:#ddd; font-size:0.8rem; padding:6px 12px;">Seed
                                        Costs</button></div>
                            </div>
                            <table class="profit-table">
                                <thead>
                                    <tr>
                                        <th>Ingredient</th>
                                        <th style="text-align:right;">Qty</th>
                                        <th style="text-align:right;">Unit Price</th>
                                        <th style="text-align:right;">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="ingredientsBody">
                                    <tr>
                                        <td>Rice (kg)</td>
                                        <td style="text-align:right;">50</td>
                                        <td style="text-align:right;">$2.00</td>
                                        <td style="text-align:right;">$100.00</td>
                                    </tr>
                                    <tr>
                                        <td>Chicken (kg)</td>
                                        <td style="text-align:right;">40
                                        </td>
                                        <td style="text-align:right;">$5.00
                                        </td>
                                        <td style="text-align:right;">$200.00
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Vegetables (kg)</td>
                                        <td style="text-align:right;">20
                                        </td>
                                        <td style="text-align:right;">$3.00
                                        </td>
                                        <td style="text-align:right;">$60.00
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Noodles (kg)</td>
                                        <td style="text-align:right;">30
                                        </td>
                                        <td style="text-align:right;">$4.00
                                        </td>
                                        <td style="text-align:right;">$120.00
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Soy Sauce (L)</td>
                                        <td style="text-align:right;">10
                                        </td>
                                        <td style="text-align:right;">$8.00
                                        </td>
                                        <td style="text-align:right;">$80.00
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Spices (kg)</td>
                                        <td style="text-align:right;">15
                                        </td>
                                        <td style="text-align:right;">$10.00
                                        </td>
                                        <td style="text-align:right;">$150.00
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Seafood (kg)</td>
                                        <td style="text-align:right;">25
                                        </td>
                                        <td style="text-align:right;">$8.00
                                        </td>
                                        <td style="text-align:right;">
                                            $200.00</td>
                                    </tr>
                                    <tr>
                                        <td>Tofu (kg)</td>
                                        <td style="text-align:right;">10
                                        </td>
                                        <td style="text-align:right;">$2.00
                                        </td>
                                        <td style="text-align:right;">$20.00
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Garlic (kg)</td>
                                        <td style="text-align:right;">5</td>
                                        <td style="text-align:right;">$6.00
                                        </td>
                                        <td style="text-align:right;">$30.00
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Onions (kg)</td>
                                        <td style="text-align:right;">10
                                        </td>
                                        <td style="text-align:right;">$4.00
                                        </td>
                                        <td style="text-align:right;">
                                            $40.00</td>
                                    </tr>
                                    <tr>
                                        <td>Cooking Oil (L)</td>
                                        <td style="text-align:right;">30
                                        </td>
                                        <td style="text-align:right;">$3.00
                                        </td>
                                        <td style="text-align:right;">$90.00
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Eggs (tray)</td>
                                        <td style="text-align:right;">20
                                        </td>
                                        <td style="text-align:right;">$6.00
                                        </td>
                                        <td style="text-align:right;">
                                            $120.00</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="total-box">Total Ingredients Cost:
                                <span style="color:#F44336;">$910.00</span>
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px;">
                            <!-- 2. Rent & Utilities -->
                            <div
                                style="background:white; padding:24px; border-radius:12px; box-shadow:var(--shadow-sm);">
                                <div
                                    style="display:flex; justify-content:space-between; align-items:top; margin-bottom:16px;">
                                    <h3 style="margin:0;">Overhead
                                        (Monthly)</h3><button onclick="openOverheadModal()"
                                        style="border:none; background:none; cursor:pointer; color:var(--primary-color);"><ion-icon
                                            name="create-outline" style="font-size:1.2rem;"></ion-icon>Edit
                                    </button>
                                </div>
                                <table class="profit-table" style="margin-bottom:0;">
                                    <tbody id="overheadBody">
                                        <!-- Dynamic Content -->
                                        <tr>
                                            <td>Loading...</td>
                                            <td></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="total-box" style="margin-top:16px; background:#f9f9f9;">
                                    Total Overhead: <span id="totalOverheadDisplay" style="color:#F44336;">$0.00</span>
                                </div>
                            </div>
                            <!-- 3. Summary Card -->
                            <div
                                style="background:white; padding:24px; border-radius:12px; box-shadow:var(--shadow-sm);">
                                <h3 style="margin-top:0;">Summary</h3>
                                <table class="profit-table" style="margin-bottom:0;">
                                    <tbody>
                                        <tr>
                                            <td>Total Revenue</td>
                                            <td style="text-align:right; color:#4CAF50; font-weight:600;">
                                                $2,500.00</td>
                                        </tr>
                                        <tr>
                                            <td>Ingredients Cost</td>
                                            <td style="text-align:right; color:#F44336;">-$910.00</td>
                                        </tr>
                                        <tr>
                                            <td>Overhead</td>
                                            <td id="overheadSummary" style="text-align:right; color:#F44336;">
                                                -$0.00</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="total-box" style="margin-top:16px; background:#E8F5E9;">Net Profit:
                                    <span id="netProfitDisplay" style="color:#4CAF50; font-weight:700;">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>
    <!-- Edit Overhead Modal -->
    <div id="overheadModal" class="modal-overlay">
        <div class="modal-form-card" style="max-width:500px;"><span class="close-icon"
                onclick="document.getElementById('overheadModal').style.display='none'">&times;</span>
            <h2 style="text-align:center; margin-bottom:24px;">Edit Overhead</h2>
            <div style="margin-bottom:16px;"><label style="display:block; font-size:0.9rem; font-weight:600;">Rent
                    ($)</label><input type="number" id="inRent"
                    style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></div>
            <div style="margin-bottom:16px;"><label style="display:block; font-size:0.9rem; font-weight:600;">Utilities
                    ($)</label><input type="number" id="inUtilities"
                    style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></div>
            <div style="margin-bottom:16px;"><label style="display:block; font-size:0.9rem; font-weight:600;">Payroll
                    ($)</label><input type="number" id="inPayroll"
                    style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></div>
            <div style="margin-bottom:16px;"><label style="display:block; font-size:0.9rem; font-weight:600;">Other
                    Expenses</label><input type="number" id="inOther"
                    style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></div>
            <div style="text-align:right; display:flex; gap:8px; justify-content:flex-end;"><button
                    onclick="document.getElementById('overheadModal').style.display='none'" class="btn"
                    style="background:#eee;">Cancel</button><button onclick="saveOverhead()" class="btn"
                    style="background:var(--primary-color); font-weight:600;">Save Changes</button></div>
        </div>
    </div>
    </div>

    <div class="card" style="margin-bottom:24px; background:#FFF8E1; padding: 24px; border-radius: 12px;">
        <h3 style="margin-top:0;">Profit Margin Tracking
        </h3>
        <p style="color: #666; margin-bottom: 0;">Monitor
            profit margins by factoring in costs like
            ingredients,
            rent,
            and other expenses.</p>
    </div>
    <!-- 1. Ingredients Table -->
    <div style="background:white; padding:24px; border-radius:12px; box-shadow:var(--shadow-sm); margin-bottom:24px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <div style="display:flex; align-items:center; gap:12px;">
                <h3 style="margin:0;">Ingredients</h3>
                <div style="position:relative;"><select id="ingredientsFilter" onchange="updateIngredientsTable()"
                        style="padding:6px 12px; border:1px solid #ddd; border-radius:6px; background:#FFC107; color:black; font-weight:500; cursor:pointer;">
                        <option value="daily">Daily
                        </option>
                        <option value="weekly">Weekly
                        </option>
                        <option value="monthly" selected>Monthly</option>
                        <option value="yearly">Yearly
                        </option>
                    </select></div>
            </div>
            <div style="display:flex; gap:8px;"><button class="btn" onclick="seedData()"
                    style="background:#FFC107; font-size:0.8rem; padding:6px 12px; font-weight:600;">Seed
                    Orders</button><button class="btn" onclick="seedItemCosts()"
                    style="background:#ddd; font-size:0.8rem; padding:6px 12px;">Seed
                    Costs</button></div>
        </div>
        <table class="profit-table">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th style="text-align:right;">
                        Quantity Used</th>
                    <th style="text-align:right;">Unit
                        Cost</th>
                    <th style="text-align:right;">Total
                        Cost</th>
                </tr>
            </thead>
            <tbody id="ingredientsBody">
                <tr>
                    <td>Rice (kg)</td>
                    <td style="text-align:right;">120
                    </td>
                    <td style="text-align:right;">$2.50
                    </td>
                    <td style="text-align:right;">
                        $300.00</td>
                </tr>
                <tr>
                    <td>Chicken (kg)</td>
                    <td style="text-align:right;">80
                    </td>
                    <td style="text-align:right;">$5.00
                    </td>
                    <td style="text-align:right;">
                        $400.00</td>
                </tr>
                <tr>
                    <td>Cooking Oil (L)</td>
                    <td style="text-align:right;">30
                    </td>
                    <td style="text-align:right;">$3.00
                    </td>
                    <td style="text-align:right;">$90.00
                    </td>
                </tr>
                <tr>
                    <td>Eggs (tray)</td>
                    <td style="text-align:right;">20
                    </td>
                    <td style="text-align:right;">$6.00
                    </td>
                    <td style="text-align:right;">
                        $120.00</td>
                </tr>
            </tbody>
        </table>
        <div class="total-box">Total Ingredients Cost:
            <span style="color:#F44336;">$910.00</span>
        </div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px;">
        <!-- 2. Rent & Utilities -->
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:var(--shadow-sm);">
            <div style="display:flex; justify-content:space-between; align-items:top; margin-bottom:16px;">
                <h3 style="margin:0;">Overhead
                    (Monthly)</h3><button onclick="openOverheadModal()"
                    style="border:none; background:none; cursor:pointer; color:var(--primary-color);"><ion-icon
                        name="create-outline" style="font-size:1.2rem;"></ion-icon>Edit
                </button>
            </div>
            <table class="profit-table" style="margin-bottom:0;">
                <tbody id="overheadBody">
                    <!-- Dynamic Content -->
                    <tr>
                        <td>Loading...</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
            <div class="total-box" style="margin-top:16px; background:#f9f9f9;">
                Total Overhead: <span id="totalOverheadDisplay" style="color:#F44336;">$0.00</span>
            </div>
        </div>
        <!-- 3. Net Profit Summary -->
        <div
            style="background:white; padding:24px; border-radius:12px; box-shadow:var(--shadow-sm); display:flex; flex-direction:column; justify-content:center;">
            <h3 style="margin-top:0; text-align:center; margin-bottom:24px;">
                Net Profit Summary (This Month)
            </h3>
            <div style="display:flex; justify-content:space-between; margin-bottom:12px; font-size:1.1rem;">
                <span>Total Revenue</span><span style="color:#4CAF50; font-weight:700;">$12,
                    500.00</span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:12px; font-size:1.1rem; color:#666;">
                <span>Total Costs</span><span style="color:#F44336; font-weight:700;">-
                    $4,
                    160.00</span>
            </div>
            <div style="border-top:2px solid #eee; margin:16px 0;">
            </div>
            <div style="display:flex; justify-content:space-between; font-size:1.5rem; font-weight:800;">
                <span>Net Profit</span><span style="color:#2E7D32;">$8,
                    340.00</span>
            </div>
        </div>
    </div>
    </div>
    </div>
    </div>
    </div>
    </div>
    </div>
    </div>
    <!-- Overhead Modal -->
    <div id="overheadModal" class="modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:white; padding:24px; border-radius:12px; width:400px; max-width:90%;">
            <h3 style="margin-top:0;">Manage Monthly Overhead</h3>
            <div style="margin-bottom:12px;"><label
                    style="display:block; font-size:0.9rem; font-weight:600;">Rent</label><input type="number"
                    id="inRent" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
            </div>
            <div style="margin-bottom:12px;"><label
                    style="display:block; font-size:0.9rem; font-weight:600;">Payroll</label><input type="number"
                    id="inPayroll" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></div>
            <div style="margin-bottom:12px;"><label style="display:block; font-size:0.9rem; font-weight:600;">Utilities
                    (Water/Elec/Gas)</label><input type="number" id="inUtilities"
                    style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></div>
            <div style="margin-bottom:16px;"><label style="display:block; font-size:0.9rem; font-weight:600;">Other
                    Expenses</label><input type="number" id="inOther"
                    style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></div>
            <div style="text-align:right; display:flex; gap:8px; justify-content:flex-end;"><button
                    onclick="document.getElementById('overheadModal').style.display='none'" class="btn"
                    style="background:#eee;">Cancel</button><button onclick="saveOverhead()" class="btn"
                    style="background:var(--primary-color); font-weight:600;">Save Changes</button></div>
        </div>
    </div>
    <!-- NOTIFICATIONS LOGIC -->
    <script>function toggleNotifications() {
            const dropdown = document.getElementById('notifDropdown');

            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
            }

            else {
                dropdown.style.display = 'none';
            }
        }

        window.onclick = function (event) {
            if (!event.target.closest('.icon-btn') && !event.target.closest('#notifDropdown')) {
                const dropdown = document.getElementById('notifDropdown');

                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }
        }

    </script>
    <!-- ANALYTICS LOGIC -->
    <script type="module">import {
            db
        }

            from '../js/firebase-config2.js';

        import {
            collection,
            query,
            where,
            onSnapshot,
            doc,
            getDoc,
            setDoc,
            updateDoc
        }

            from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        let completedOrders = [];
        let menuItems = [];

        let overheadData = {
            rent: 0, payroll: 0, utilities: 0, other: 0
        }

            ;
        let earningsChart;
        let revenueChart;

        // --- Overhead Functions ---
        window.openOverheadModal = () => {
            document.getElementById('inRent').value = overheadData.rent || 0;
            document.getElementById('inPayroll').value = overheadData.payroll || 0;
            document.getElementById('inUtilities').value = overheadData.utilities || 0;
            document.getElementById('inOther').value = overheadData.other || 0;
            document.getElementById('overheadModal').style.display = 'flex';
        }

            ;

        window.saveOverhead = async () => {
            const data = {
                rent: Number(document.getElementById('inRent').value) || 0,
                payroll: Number(document.getElementById('inPayroll').value) || 0,
                utilities: Number(document.getElementById('inUtilities').value) || 0,
                other: Number(document.getElementById('inOther').value) || 0,
            }

                ;

            try {
                await setDoc(doc(db, "settings", "financials"), data);
                document.getElementById('overheadModal').style.display = 'none';
                // Listener will auto-update UI
            }

            catch (e) {
                console.error("Save error:", e);
                alert("Failed to save overheads: " + e.message);
            }
        }

            ;

        // --- Cost Seeding (One-off) ---
        window.seedItemCosts = async () => {
            if (!confirm("This will set a random cost (30-50% of price) for ANY menu item that currently has COST = 0. Continue?")) return;

            const toUpdate = menuItems.filter(m => !m.cost);

            if (toUpdate.length === 0) {
                alert("All items already have costs!");
                return;
            }

            let count = 0;

            const promises = toUpdate.map(m => {
                const randomPct = 0.3 + (Math.random() * 0.2); // 0.3 to 0.5
                const newCost = Math.round((Number(m.price) * randomPct) * 100) / 100;
                count++;

                return updateDoc(doc(db, "menu_items", m.id), {
                    cost: newCost
                });
            });

            await Promise.all(promises);

            alert(`Updated ${count} items with estimated costs.`);
        }

            ;

        // Make functions globally available for HTML onclick handlers
        window.switchView = (viewId, btn) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            document.querySelectorAll('.analytics-nav .btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');

            // Resize check
            if (viewId === 'revenue' && revenueChart) {
                revenueChart.resize();
            }
        }

            ;

        window.toggleEarnings = (period) => {
            if (!earningsChart) return;

            const labels = [];
            const data = [];
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            if (period === 'weekly') {

                // Last 7 days
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(now);
                    d.setDate(d.getDate() - i);

                    labels.push(d.toLocaleDateString('en-US', {
                        weekday: 'short'
                    }));

                    // Sum revenue for this day
                    const dayTotal = completedOrders.filter(o => isSameDay(o.timestamp ? o.timestamp.toDate() : new Date(), d)).reduce((sum, o) => sum + calculateOrderTotal(o), 0);
                    data.push(dayTotal);
                }
            }

            else if (period === 'monthly') {
                // Breakdown by Weeks for the *Current Month*
                labels.push('Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5');
                const weeklyTotals = [0,
                    0,
                    0,
                    0,
                    0];

                completedOrders.forEach(o => {
                    const d = o.timestamp ? o.timestamp.toDate() : new Date();

                    // Filter for current month and year
                    if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                        const date = d.getDate();
                        // Simple chunking: 1-7, 8-14, 15-21, 22-28, 29+
                        const weekIndex = Math.floor((date - 1) / 7);

                        if (weekIndex <= 4) {
                            weeklyTotals[weekIndex] += calculateOrderTotal(o);
                        }
                    }
                });
                data.push(...weeklyTotals);

            }

            else if (period === 'yearly') {
                // Jan - Dec for Current Year
                const months = ['Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sep',
                    'Oct',
                    'Nov',
                    'Dec'];
                labels.push(...months);
                const monthlyTotals = new Array(12).fill(0);

                completedOrders.forEach(o => {
                    const d = o.timestamp ? o.timestamp.toDate() : new Date();

                    if (d.getFullYear() === currentYear) {
                        monthlyTotals[d.getMonth()] += calculateOrderTotal(o);
                    }
                });
                data.push(...monthlyTotals);

            }

            else if (period === 'hourly') {

                // Today's hourly breakdown (2-hour blocks)
                for (let i = 8; i <= 22; i += 2) {
                    labels.push(`${i}:00`);

                    const hourTotal = completedOrders.filter(o => {
                        const d = o.timestamp ? o.timestamp.toDate() : new Date();
                        return isSameDay(d, now) && d.getHours() >= i && d.getHours() < i + 2;
                    }).reduce((sum, o) => sum + calculateOrderTotal(o), 0);
                    data.push(hourTotal);
                }
            }

            earningsChart.data.labels = labels;
            earningsChart.data.datasets[0].data = data;
            earningsChart.update();
        }

            ;

        const colors = ['#F44336',
            '#E91E63',
            '#9C27B0',
            '#673AB7',
            '#3F51B5',
            '#2196F3',
            '#03A9F4',
            '#00BCD4',
            '#009688',
            '#4CAF50',
            '#8BC34A',
            '#CDDC39',
            '#FFEB3B',
            '#FFC107',
            '#FF9800',
            '#FF5722'];

        window.updateRevenueView = () => {
            if (!revenueChart) return;

            const itemSelect = document.getElementById('itemSelect');
            const selectedItem = itemSelect.value;
            const title = document.getElementById('revenueTitle');
            const subtitle = document.getElementById('revenueSubtitle');
            const periodSelect = document.getElementById('revenuePeriod');
            const period = periodSelect ? periodSelect.value : 'weekly';

            // Generate labels based on period
            let labels = [];
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            if (period === 'weekly') {
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(now);
                    d.setDate(d.getDate() - i);

                    labels.push(d.toLocaleDateString('en-US', {
                        weekday: 'short'
                    }));
                }
            }

            else if (period === 'monthly') {
                labels = ['Week 1',
                    'Week 2',
                    'Week 3',
                    'Week 4',
                    'Week 5'];
            }

            else if (period === 'yearly') {
                labels = ['Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sep',
                    'Oct',
                    'Nov',
                    'Dec'];
            }

            let datasets = [];

            if (selectedItem === 'all') {
                // Check if elements exist before styling
                const revPeriod = document.getElementById('revenuePeriod');
                if (revPeriod) revPeriod.style.display = 'block';

                const dateSel = document.getElementById('dateSelect');
                if (dateSel) dateSel.style.display = 'none';

                title.innerText = 'Revenue Trends (All Items)';

                let subtitleText = '';
                if (period === 'weekly') subtitleText = 'Daily revenue per menu item (Last 7 Days).';
                else if (period === 'monthly') subtitleText = 'Weekly revenue breakdown (Current Month).';
                else if (period === 'yearly') subtitleText = 'Monthly revenue breakdown (Current Year).';

                subtitle.innerText = subtitleText;

                // Identify items to show: Top 5 by default or all? 
                // Use known menu items for consistency
                const allItemNames = new Set(menuItems.map(m => m.name));
                // Also add any items found in order history that might have been deleted
                completedOrders.forEach(o => (o.items || []).forEach(i => allItemNames.add(i.name)));

                // Calculate total revenue per item to find top 5
                const itemTotalRevenue = {}

                    ;
                allItemNames.forEach(name => itemTotalRevenue[name] = 0);

                completedOrders.forEach(o => {
                    (o.items || []).forEach(i => {
                        if (itemTotalRevenue[i.name] !== undefined) {
                            itemTotalRevenue[i.name] += (i.price || 0) * i.qty;
                        }

                        else {
                            itemTotalRevenue[i.name] = (i.price || 0) * i.qty;
                        }
                    });
                });

                // Sort and take top 5
                const topItems = Object.entries(itemTotalRevenue).sort((a, b) => b[1] - a[1]).slice(0, 5).map(entry => entry[0]);

                let colorIdx = 0;

                topItems.forEach(itemName => {
                    let itemData = [];

                    if (period === 'weekly') {
                        itemData = [];

                        for (let i = 6; i >= 0; i--) {
                            const d = new Date(now);
                            d.setDate(d.getDate() - i);

                            const val = completedOrders.filter(o => isSameDay(o.timestamp ? o.timestamp.toDate() : new Date(), d)).reduce((sum, o) => {
                                const itemInOrder = (o.items || []).find(i => i.name === itemName);
                                return sum + (itemInOrder ? (itemInOrder.price || 0) * itemInOrder.qty : 0);
                            }

                                , 0);
                            itemData.push(val);
                        }
                    }

                    else if (period === 'monthly') {
                        itemData = [0, 0, 0, 0, 0];

                        completedOrders.forEach(o => {
                            const d = o.timestamp ? o.timestamp.toDate() : new Date();

                            if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                                const weekIndex = Math.floor((d.getDate() - 1) / 7);

                                if (weekIndex <= 4) {
                                    const itemInOrder = (o.items || []).find(i => i.name === itemName);
                                    if (itemInOrder) itemData[weekIndex] += (itemInOrder.price || 0) * itemInOrder.qty;
                                }
                            }
                        });
                    }

                    else if (period === 'yearly') {
                        itemData = new Array(12).fill(0);

                        completedOrders.forEach(o => {
                            const d = o.timestamp ? o.timestamp.toDate() : new Date();

                            if (d.getFullYear() === currentYear) {
                                const itemInOrder = (o.items || []).find(i => i.name === itemName);
                                if (itemInOrder) itemData[d.getMonth()] += (itemInOrder.price || 0) * itemInOrder.qty;
                            }
                        });
                    }

                    datasets.push({
                        label: itemName,
                        data: itemData,
                        borderColor: colors[colorIdx % colors.length],
                        backgroundColor: 'transparent',
                        tension: 0.3,
                        borderWidth: 2
                    });
                    colorIdx++;
                });

            }

            else {
                const revPeriod = document.getElementById('revenuePeriod');
                if (revPeriod) revPeriod.style.display = 'block';
                const dateSel = document.getElementById('dateSelect');
                if (dateSel) dateSel.style.display = 'none';

                title.innerText = `Revenue: $ {
                formatName(selectedItem)
            }

            `;
                subtitle.innerText = "Revenue trend.";

                let itemData = [];

                if (period === 'weekly') {
                    for (let i = 6; i >= 0; i--) {
                        const d = new Date(now);
                        d.setDate(d.getDate() - i);

                        const val = completedOrders.filter(o => isSameDay(o.timestamp ? o.timestamp.toDate() : new Date(), d)).reduce((sum, o) => {
                            const item = (o.items || []).find(i => i.name === selectedItem);
                            return sum + (item ? (item.price || 0) * item.qty : 0);
                        }

                            , 0);
                        itemData.push(val);
                    }
                }

                else if (period === 'monthly') {
                    const weeklyTotals = [0,
                        0,
                        0,
                        0,
                        0];

                    completedOrders.forEach(o => {
                        const d = o.timestamp ? o.timestamp.toDate() : new Date();

                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const weekIndex = Math.floor((d.getDate() - 1) / 7);

                            if (weekIndex <= 4) {
                                const item = (o.items || []).find(i => i.name === selectedItem);
                                if (item) weeklyTotals[weekIndex] += (item.price || 0) * item.qty;
                            }
                        }
                    });
                    itemData.push(...weeklyTotals);
                }

                else if (period === 'yearly') {
                    const monthlyTotals = new Array(12).fill(0);

                    completedOrders.forEach(o => {
                        const d = o.timestamp ? o.timestamp.toDate() : new Date();

                        if (d.getFullYear() === currentYear) {
                            const item = (o.items || []).find(i => i.name === selectedItem);
                            if (item) monthlyTotals[d.getMonth()] += (item.price || 0) * item.qty;
                        }
                    });
                    itemData.push(...monthlyTotals);
                }

                datasets.push({
                    label: selectedItem,
                    data: itemData,
                    borderColor: '#FFC107',
                    backgroundColor: '#FFC10720',
                    fill: true,
                    tension: 0.3
                });
            }

            revenueChart.data = {
                labels,
                datasets
            }

                ;
            revenueChart.update();
        }

            ;

        window.updateIngredientsTable = () => {
            const period = document.getElementById('ingredientsFilter').value;
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            // 1. Calculate Usage and Costs
            const itemUsage = {}

                ; // { itemName: { qty: 0, cost: 0, totalCost: 0 } }

            completedOrders.forEach(o => {
                const d = o.timestamp ? o.timestamp.toDate() : new Date();
                let match = false;

                if (period === 'daily') {
                    match = isSameDay(d, now);
                }

                else if (period === 'weekly') {
                    const diffTime = Math.abs(now - d);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    match = diffDays <= 7;
                }

                else if (period === 'monthly') {
                    match = d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }

                else if (period === 'yearly') {
                    match = d.getFullYear() === currentYear;
                }

                if (match) {
                    (o.items || []).forEach(i => {
                        if (!itemUsage[i.name]) {
                            // Find cost from menuItems menu source
                            const menuDef = menuItems.find(m => m.name === i.name);
                            const unitCost = menuDef ? (Number(menuDef.cost) || 0) : 0;

                            itemUsage[i.name] = {
                                qty: 0, unitCost: unitCost, totalCost: 0, revenue: 0
                            }

                                ;
                        }

                        itemUsage[i.name].qty += i.qty;
                        itemUsage[i.name].totalCost += (itemUsage[i.name].unitCost * i.qty);
                        itemUsage[i.name].revenue += (i.price * i.qty);
                    });
                }
            });

            // 2. Render Table
            const tbody = document.getElementById('ingredientsBody');

            if (tbody) {
                tbody.innerHTML = '';
                let totalIngredientsCost = 0;
                let totalRevenue = 0;

                Object.entries(itemUsage).forEach(([name, data]) => {
                    if (data.qty > 0) {
                        totalIngredientsCost += data.totalCost;
                        totalRevenue += data.revenue;

                        const row = ` <tr> <td>$ {
                                name
                            }

                            </td> <td style="text-align:right;" >$ {
                                data.qty
                            }

                            </td> <td style="text-align:right;" >$$ {
                                data.unitCost.toFixed(2)
                            }

                            </td> <td style="text-align:right;" >$$ {
                                data.totalCost.toFixed(2)
                            }

                            </td> </tr> `;
                        tbody.innerHTML += row;
                    }
                });

                // Total Box
                const totalBox = document.querySelector('#profit .total-box span');

                if (totalBox) totalBox.innerText = `$$ {
                    totalIngredientsCost.toFixed(2)
                }

                `;

                // 3. Update Net Profit Summary
                // Real Overhead Data
                const monthlyTotal = (overheadData.rent || 0) + (overheadData.payroll || 0) + (overheadData.utilities || 0) + (overheadData.other || 0);

                // Scale overhead based on period
                let scaler = 1;
                if (period === 'daily') scaler = 1 / 30;
                if (period === 'weekly') scaler = 1 / 4;
                if (period === 'yearly') scaler = 12;

                const overhead = monthlyTotal * scaler;

                // Update Overhead Table (UI)
                const ovBody = document.getElementById('overheadBody');

                if (ovBody) {
                    ovBody.innerHTML = ` <tr><td>Rent</td><td style="text-align:right;">$$ {
                        ((overheadData.rent || 0) * scaler).toFixed(2)
                    }

                    </td></tr><tr><td>Payroll</td><td style="text-align:right;">$$ {
                        ((overheadData.payroll || 0) * scaler).toFixed(2)
                    }

                    </td></tr><tr><td>Utilities</td><td style="text-align:right;">$$ {
                        ((overheadData.utilities || 0) * scaler).toFixed(2)
                    }

                    </td></tr><tr><td>Other</td><td style="text-align:right;">$$ {
                        ((overheadData.other || 0) * scaler).toFixed(2)
                    }

                    </td></tr>`;
                    const disp = document.getElementById('totalOverheadDisplay');

                    if (disp) disp.innerText = `$$ {
                        overhead.toFixed(2)
                    }

                    `;
                }

                const netProfit = totalRevenue - totalIngredientsCost - overhead;

                // Update Summary DOM
                const summaryBox = document.querySelector('#profit div[style*="grid-template-columns"] > div:last-child');

                if (summaryBox) {
                    summaryBox.innerHTML = ` <h3 style="margin-top:0; text-align:center; margin-bottom:24px;">Net Profit Summary ($ {
                            period

                        })</h3><div style="display:flex; justify-content:space-between; margin-bottom:12px; font-size:1.1rem;"><span>Total Revenue</span><span style="color:#4CAF50; font-weight:700;">$$ {
                        totalRevenue.toFixed(2)
                    }

                    </span></div><div style="display:flex; justify-content:space-between; margin-bottom:12px; font-size:1.1rem; color:#666;"><span>Total Costs (Ingr. + Overhead)</span><span style="color:#F44336; font-weight:700;">- $$ {
                        (totalIngredientsCost + overhead).toFixed(2)
                    }

                    </span></div><div style="border-top:2px solid #eee; margin:16px 0;"></div><div style="display:flex; justify-content:space-between; font-size:1.5rem; font-weight:800;"><span>Net Profit</span><span style="color:${netProfit >= 0 ? '#2E7D32' : '#F44336'};">$$ {
                        netProfit.toFixed(2)
                    }

                    </span></div>`;
                }
            }
        }

            ;

        // --- Data Seeding (Dev Tool) ---
        window.seedData = async () => {
            if (!confirm("Generate 50 random past orders? This is for testing.")) return;

            const itemsPool = [{
                name: 'Chicken Rice', price: 5.50
            }

                ,
            {
                name: 'Hokkien Mee', price: 6.00
            }

                ,
            {
                name: 'Oyster Omelet', price: 8.50
            }

                ,
            {
                name: 'Iced Milo', price: 2.00
            }

                ,
            {
                name: 'Teh O', price: 1.50
            }

                ,
            {
                name: 'Bandung', price: 2.50
            }

                ,
            {
                name: 'Satay (10 sticks)', price: 12.00
            }

            ];

            const batchPromises = [];
            const now = new Date();

            import("https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js").then(async ({
                addDoc, collection, Timestamp

            }) => {
                for (let i = 0; i < 50; i++) {
                    // Random date within last 30 days
                    const pastDate = new Date(now.getTime() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                    // Random hour (10am - 9pm)
                    pastDate.setHours(10 + Math.floor(Math.random() * 11), Math.floor(Math.random() * 60));

                    // Random items (1 to 4 items)
                    const orderItems = [];
                    const numItems = Math.floor(Math.random() * 4) + 1;

                    for (let j = 0; j < numItems; j++) {
                        const item = itemsPool[Math.floor(Math.random() * itemsPool.length)];

                        orderItems.push({
                            name: item.name, price: item.price, qty: Math.floor(Math.random() * 2) + 1
                        });
                    }

                    batchPromises.push(addDoc(collection(db, "orders"), {
                        customerName: "Seeded Guest",
                        items: orderItems,
                        notes: "Auto-generated",
                        status: "completed",
                        tableNo: Math.floor(Math.random() * 20) + 1,
                        timestamp: Timestamp.fromDate(pastDate)
                    }));
                }

                await Promise.all(batchPromises);
                alert("Seeding complete! Charts should update.");
            });
        }

            ;


        // --- Helper Functions ---

        function calculateOrderTotal(order) {
            return (order.items || []).reduce((acc, item) => acc + ((item.price || 5) * item.qty), 0);
        }

        function isSameDay(d1, d2) {
            // Handle Firebase Timestamp or JS Date
            const date1 = d1.toDate ? d1.toDate() : d1;
            const date2 = d2.toDate ? d2.toDate() : d2;

            return date1.getFullYear() === date2.getFullYear() && date1.getMonth() === date2.getMonth() && date1.getDate() === date2.getDate();
        }

        function formatName(str) {
            if (!str) return '';
            return str.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function updateItemSelectOptions() {
            const select = document.getElementById('itemSelect');
            if (!select) return;

            // Get all items from menu and orders
            const items = new Set();
            menuItems.forEach(m => items.add(m.name));

            completedOrders.forEach(o => {
                if (o.items) o.items.forEach(i => items.add(i.name));
            });

            const currentVal = select.value;
            select.innerHTML = '<option value="all">All Items</option>';

            items.forEach(item => {
                if (!item) return;
                const opt = document.createElement('option');
                opt.value = item;
                opt.innerText = item;
                select.appendChild(opt);
            });
            select.value = currentVal || 'all';
        }

        // --- Init Function ---
        function initCharts() {

            // Destroy existing charts to prevent "Canvas is already in use" error
            if (earningsChart) {
                earningsChart.destroy();
            }

            if (revenueChart) {
                revenueChart.destroy();
            }

            // Init Earnings Chart
            const ctx1 = document.getElementById('earningsChart').getContext('2d');

            earningsChart = new Chart(ctx1, {

                type: 'line',
                data: {

                    labels: [],
                    datasets: [{
                        label: 'Revenue ($)',
                        data: [],
                        borderColor: '#FFC107',
                        backgroundColor: '#FFC10720',
                        fill: true,
                        tension: 0.4
                    }

                    ]
                }

                ,
                options: {
                    responsive: true, maintainAspectRatio: false
                }
            });

            // Init Revenue Chart
            const ctx2 = document.getElementById('revenueChart').getContext('2d');

            revenueChart = new Chart(ctx2, {

                type: 'line',
                data: {
                    labels: [], datasets: []
                }

                ,
                options: {
                    responsive: true, maintainAspectRatio: false
                }
            });
        }

        // --- Firebase Listener ---
        const q = query(collection(db, "orders"), where("status", "in", ["completed", "served"]));

        onSnapshot(q, (snapshot) => {
            completedOrders = [];

            snapshot.forEach(doc => {
                completedOrders.push({
                    id: doc.id, ...doc.data()
                });
            });
            console.log("Loaded Completed Orders:", completedOrders.length);
            refreshAll();
        });

        // 3. Overhead Settings
        onSnapshot(doc(db, "settings", "financials"), (docSnap) => {
            if (docSnap.exists()) {
                overheadData = docSnap.data();
            }

            else {

                // Default if not set
                overheadData = {
                    rent: 2500, payroll: 5000, utilities: 450, other: 120
                }

                    ;
            }

            refreshAll();
        });

        onSnapshot(collection(db, "menu_items"), (snapshot) => {
            menuItems = [];

            snapshot.forEach(doc => {
                menuItems.push({
                    id: doc.id, ...doc.data()
                });
            });
            console.log("Loaded Menu Items:", menuItems.length);
            refreshAll();
        });

        function refreshAll() {

            // Only update if charts exist
            if (!earningsChart) {
                initCharts();
            }

            // Wait for data to actually spawn elements or chart to be ready
            if (earningsChart) toggleEarnings(document.getElementById('earningsPeriod').value);
            updateItemSelectOptions();
            updateRevenueView();
        }

    </script>
</body>

</html>